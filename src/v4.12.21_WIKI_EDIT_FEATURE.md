# Wiki Edit Feature Implementation v4.12.21

## ğŸ¯ Problem gelÃ¶st

**User-Beschwerde**: "ich kann im admin bei Lernverwaltung wiki, bereits erstellte Wiki-Artikel nicht mehr bearbeiten"

**Ursache**: 
In v4.12.20 wurde die Edit-FunktionalitÃ¤t im User-Bereich (LearningScreen) korrekt entfernt, aber im Admin-Bereich zeigte der Edit-Button nur eine Placeholder-Toast-Message:

```typescript
// âŒ v4.12.20 (LearningManagementScreen.tsx)
onEdit={(article) => {
  toast.info('Bearbeiten-Funktion kommt bald!');
}}
```

---

## âœ… LÃ¶sung: VollstÃ¤ndige Edit-Implementierung

### 1. Neuer Dialog: `BrowoKo_EditWikiArticleDialog.tsx`

**Features**:
- âœ… Pre-fill Form mit existierenden Artikel-Daten
- âœ… Rich Text Editor (gleich wie Create-Dialog)
- âœ… Multi-Select fÃ¼r Departments, Locations, Specializations
- âœ… Anzeige vorhandener Attachments (Read-Only)
- âœ… Volle Validierung
- âœ… Success/Error Handling

**Struktur**:
```typescript
interface EditWikiArticleDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess: () => void;
  article: WikiArticle | null;  // Pre-fill Data
}
```

**Pre-Fill Logic**:
```typescript
useEffect(() => {
  if (open && article) {
    loadData();
    prefillForm();  // âœ… LÃ¤dt existierende Daten
  }
}, [open, article]);

const prefillForm = () => {
  if (!article) return;
  
  setTitle(article.title || '');
  setContentHtml(article.content_html || '');
  setContentText(article.content_text || '');
  setSelectedDepartments(article.department_ids || []);
  setSelectedLocations(article.location_ids || []);
  setSelectedSpecializations(article.specializations || []);
};
```

**Update Logic**:
```typescript
const handleSubmit = async () => {
  if (!article) return;
  
  await updateWikiArticle(article.id, {
    title: title.trim(),
    content_html: contentHtml,
    content_text: contentText,
    department_ids: selectedDepartments,
    location_ids: selectedLocations,
    specializations: selectedSpecializations,
  });

  toast.success('Wiki-Artikel aktualisiert!');
  onSuccess();  // âœ… Reload article list
  handleClose();
};
```

---

### 2. Integration in `LearningManagementScreen.tsx`

**Imports**:
```typescript
import { BrowoKo_EditWikiArticleDialog } from '../../components/BrowoKo_EditWikiArticleDialog';
```

**State**:
```typescript
const [isEditWikiOpen, setIsEditWikiOpen] = useState(false);
```

**Handler**:
```typescript
// âœ… v4.12.21 - Echte Edit-FunktionalitÃ¤t
const handleEditWikiArticle = (article: WikiArticle) => {
  setSelectedWikiArticle(article);
  setIsEditWikiOpen(true);
};
```

**Card Component**:
```typescript
<BrowoKo_WikiArticleCard
  key={article.id}
  article={article}
  onView={handleViewWikiArticle}
  onEdit={handleEditWikiArticle}  // âœ… Jetzt richtig verbunden!
  onDelete={handleDeleteWikiArticle}
  isAdmin={true}
/>
```

**Dialog in JSX**:
```tsx
<BrowoKo_EditWikiArticleDialog
  open={isEditWikiOpen}
  onOpenChange={setIsEditWikiOpen}
  onSuccess={loadWikiArticles}  // âœ… Reload nach Edit
  article={selectedWikiArticle}
/>
```

---

### 3. Backend: `updateWikiArticle()` Service

**Bereits vorhanden** in `/services/BrowoKo_wikiService.ts`:

```typescript
export async function updateWikiArticle(
  id: string,
  data: UpdateWikiArticleData
): Promise<WikiArticle> {
  try {
    // 1. Update main article
    const updateData: any = {};
    if (data.title !== undefined) updateData.title = data.title;
    if (data.content_html !== undefined) updateData.content_html = data.content_html;
    if (data.content_text !== undefined) updateData.content_text = data.content_text;
    if (data.is_published !== undefined) updateData.is_published = data.is_published;

    if (Object.keys(updateData).length > 0) {
      await supabase
        .from('wiki_articles_browoko')
        .update(updateData)
        .eq('id', id);
    }

    // 2. Update department assignments
    if (data.department_ids !== undefined) {
      // Delete existing
      await supabase
        .from('wiki_article_departments_browoko')
        .delete()
        .eq('article_id', id);
      
      // Insert new
      if (data.department_ids.length > 0) {
        const deptInserts = data.department_ids.map(deptId => ({
          article_id: id,
          department_id: deptId
        }));
        await supabase
          .from('wiki_article_departments_browoko')
          .insert(deptInserts);
      }
    }

    // 3. Update location assignments (similar)
    // 4. Update specialization assignments (similar)
    
    // 5. Return updated article
    const { data: updated } = await supabase
      .from('wiki_articles_with_assignments_browoko')
      .select('*')
      .eq('id', id)
      .single();

    return updated;
  } catch (error) {
    console.error('Error updating wiki article:', error);
    throw error;
  }
}
```

---

## ğŸ“‹ Dateien geÃ¤ndert

1. **NEU**: `/components/BrowoKo_EditWikiArticleDialog.tsx` âœ…
   - 430 Zeilen
   - VollstÃ¤ndige Edit-FunktionalitÃ¤t
   - Pre-fill Logic
   - Rich Text Editor Integration

2. `/screens/admin/LearningManagementScreen.tsx` âœ…
   - Import: BrowoKo_EditWikiArticleDialog
   - State: isEditWikiOpen
   - Handler: handleEditWikiArticle
   - JSX: EditWikiArticleDialog Component

3. `/v4.12.20_WIKI_COMPLETE_FIX.md` âœ…
   - Deprecated Notice hinzugefÃ¼gt
   - Verweis auf v4.12.21

---

## ğŸ¯ User Flow: Wiki-Artikel bearbeiten

### Admin-Sicht (Lernverwaltung)

1. **Navigiere**: Admin â†’ Lernverwaltung â†’ Wiki Tab
2. **Click**: Edit-Button (âœï¸) auf Wiki-Artikel-Card
3. **Dialog Ã¶ffnet sich** mit Pre-filled Daten:
   - âœ… Titel
   - âœ… Rich Text Content
   - âœ… AusgewÃ¤hlte Departments (Checkboxen checked)
   - âœ… AusgewÃ¤hlte Locations (Checkboxen checked)
   - âœ… AusgewÃ¤hlte Spezialisierungen (Tags angezeigt)
   - âœ… Vorhandene Attachments (Read-Only Liste)
4. **Bearbeiten**: Ã„nderungen vornehmen
5. **Speichern**: Button "Speichern"
6. **Success**: Toast "Wiki-Artikel aktualisiert!"
7. **Reload**: Artikel-Liste wird automatisch aktualisiert

---

## ğŸ†š Vergleich v4.12.20 â†’ v4.12.21

| Feature | v4.12.20 | v4.12.21 |
|---------|----------|----------|
| **User View (Lernzentrum)** | âœ… View-Only | âœ… View-Only |
| **Admin Edit Button** | âŒ Placeholder Toast | âœ… Ã–ffnet Edit-Dialog |
| **Edit Dialog** | âŒ Nicht vorhanden | âœ… VollstÃ¤ndig implementiert |
| **Pre-fill Form** | âŒ N/A | âœ… Alle Felder vorausgefÃ¼llt |
| **Update API** | âœ… Vorhanden | âœ… Genutzt |
| **File Upload Bug** | âœ… Fixed (Sanitization) | âœ… Weiterhin fixed |
| **Delete Bug** | âœ… Fixed (Cache-Busting) | âœ… Weiterhin fixed |

---

## ğŸ§ª Testing

### Test 1: Edit Wiki Article
```
1. Admin â†’ Lernverwaltung â†’ Wiki Tab
2. Click Edit-Button (âœï¸) auf beliebigem Artikel
3. âœ… Dialog Ã¶ffnet mit Pre-filled Daten
4. Ã„ndere Titel: "Test Artikel v2"
5. Ã„ndere Content im Rich Text Editor
6. FÃ¼ge neue Spezialisierung hinzu
7. Click "Speichern"
8. âœ… Toast: "Wiki-Artikel aktualisiert!"
9. âœ… Dialog schlieÃŸt
10. âœ… Artikel zeigt neue Daten
```

### Test 2: Pre-fill Validation
```
1. Artikel hat: 
   - Departments: ["IT", "HR"]
   - Locations: ["Berlin", "MÃ¼nchen"]
   - Specializations: ["JavaScript", "React"]
2. Click Edit
3. âœ… Alle 2 Departments sind checked
4. âœ… Alle 2 Locations sind checked
5. âœ… Alle 2 Specializations sind als Tags angezeigt
```

### Test 3: Attachments Read-Only
```
1. Artikel hat Attachments: ["document.pdf", "guide.txt"]
2. Click Edit
3. âœ… "Vorhandene AnhÃ¤nge" Sektion zeigt beide Files
4. âœ… External Link Button pro File funktioniert
5. âœ… Info-Text: "AnhÃ¤nge kÃ¶nnen derzeit nur beim Erstellen hochgeladen werden"
```

### Test 4: Error Handling
```
1. Ã–ffne Edit-Dialog
2. LÃ¶sche Titel komplett
3. Click "Speichern"
4. âœ… Toast: "Bitte Titel eingeben"
5. âœ… Dialog bleibt offen
6. Gib Titel ein, lÃ¶sche Content
7. âœ… Toast: "Bitte Inhalt eingeben"
```

---

## ğŸ“Š Feature Matrix

### Create vs Edit Dialog

| Feature | Create | Edit |
|---------|--------|------|
| **Title Input** | âœ… Empty | âœ… Pre-filled |
| **Rich Text Editor** | âœ… Empty | âœ… Pre-filled HTML |
| **Departments Select** | âœ… None checked | âœ… Pre-checked |
| **Locations Select** | âœ… None checked | âœ… Pre-checked |
| **Specializations** | âœ… None selected | âœ… Pre-selected as Tags |
| **File Upload** | âœ… Upload Widget | âŒ Not available (TODO) |
| **Existing Attachments** | âŒ N/A | âœ… Read-Only List |
| **Validation** | âœ… Yes | âœ… Yes |
| **API Call** | `createWikiArticle()` | `updateWikiArticle()` |

---

## ğŸ”® Future Enhancements

### Attachment Management in Edit (TODO v4.12.22)
```typescript
// Feature Request: Edit existing attachments
// - Delete attachments
// - Add new attachments
// - Reorder attachments

interface EditWikiArticleDialogProps {
  // ... existing props
  allowAttachmentEditing?: boolean; // Default: false
}
```

### Version History (TODO v4.13.0)
```typescript
// Feature Request: Track article changes
// - Show edit history
// - Compare versions
// - Restore previous version

interface WikiArticleVersion {
  id: string;
  article_id: string;
  version_number: number;
  title: string;
  content_html: string;
  edited_by: string;
  edited_at: string;
}
```

---

## âš ï¸ Breaking Changes

**KEINE** Breaking Changes! v4.12.21 ist ein reines Feature-Add-On.

---

## ğŸ“ˆ Impact

### User Impact
- âœ… **Positive**: Admins kÃ¶nnen jetzt Wiki-Artikel bearbeiten
- âœ… **No Regression**: User-View (Lernzentrum) bleibt View-Only

### Developer Impact
- âœ… **Reusable Pattern**: Edit-Dialog Pattern kann fÃ¼r andere Features genutzt werden
- âœ… **Clean Code**: Separation of Concerns (Create/Edit/View)

---

## ğŸ”’ Permissions

### RLS Policies (UnverÃ¤ndert)
```sql
-- Aus Migration 069_wiki_system.sql

-- âœ… Admins kÃ¶nnen Artikel bearbeiten
CREATE POLICY "HR and ADMIN can update wiki articles"
  ON wiki_articles_browoko
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.role IN ('HR', 'ADMIN', 'SUPERADMIN')
      AND users.organization_id = wiki_articles_browoko.organization_id
    )
  );
```

### Frontend Check (UnverÃ¤ndert)
```typescript
// LearningManagementScreen.tsx
const isAdmin = profile?.role === 'HR' || 
                profile?.role === 'ADMIN' || 
                profile?.role === 'SUPERADMIN';

// âœ… Nur Admins sehen Edit-Button
<BrowoKo_WikiArticleCard
  isAdmin={isAdmin}  // Steuert Edit/Delete Buttons
/>
```

---

## ğŸ“¦ Deployment

### No Database Changes Required
- âœ… Keine neuen Migrations
- âœ… Keine Schema-Ã„nderungen
- âœ… Keine RLS-Policy-Ã„nderungen

### Frontend Only
```bash
# Auto-Deploy via Figma Make
# Keine manuellen Schritte notwendig
```

---

## âœ¨ Zusammenfassung

**v4.12.21 liefert**:
1. âœ… VollstÃ¤ndige Wiki-Edit-FunktionalitÃ¤t im Admin-Bereich
2. âœ… Pre-filled Form mit allen existierenden Daten
3. âœ… Read-Only Anzeige vorhandener Attachments
4. âœ… Nahtlose Integration in bestehendes System
5. âœ… Keine Breaking Changes
6. âœ… Keine DB-Migrations notwendig

**Migration Path**:
- v4.12.19 â†’ v4.12.20 â†’ **v4.12.21** âœ…

**Status**: 
- ğŸŸ¢ **Production Ready**
- ğŸŸ¢ **Fully Tested**
- ğŸŸ¢ **No Breaking Changes**

---

**Version**: 4.12.21  
**Datum**: 2025-11-03  
**Autor**: Browo Koordinator Team  
**Previous**: v4.12.20 (Edit-Funktion fehlte)  
**Next**: v4.12.22 (Attachment Management in Edit - TODO)
