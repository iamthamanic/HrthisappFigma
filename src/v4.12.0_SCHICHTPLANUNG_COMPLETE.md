# üéØ Schichtplanung System v4.12.0 - COMPLETE!

## ‚úÖ **WAS WURDE IMPLEMENTIERT:**

### **1. DATENBANK MIGRATION** (`/v4.12.0_SCHICHTPLANUNG_MIGRATION.sql`)

#### **Users Table Erweiterung:**
```sql
ALTER TABLE users ADD COLUMN specialization TEXT;
CREATE INDEX idx_users_specialization ON users(specialization);
```

#### **Shifts Table Erweiterung:**
```sql
ALTER TABLE shifts ADD COLUMN location_id UUID REFERENCES locations(id);
ALTER TABLE shifts ADD COLUMN department_id UUID REFERENCES departments(id);
ALTER TABLE shifts ADD COLUMN specialization TEXT;
```

#### **Organigram ‚Üí User Sync Trigger:**
```sql
CREATE TRIGGER trigger_sync_organigram_specialization
  AFTER UPDATE ON organigram_nodes
  FOR EACH ROW
  EXECUTE FUNCTION sync_organigram_specialization_to_user();
```

**Funktionsweise:**
- Wenn `organigram_nodes.specialization` ge√§ndert wird
- Wird automatisch `users.specialization` aktualisiert
- Organigram ist Master!

---

### **2. UI KOMPONENTEN**

#### **A) FieldManagementScreen** (`/screens/admin/FieldManagementScreen.tsx`)
**√Ñnderungen:**
- ‚úÖ "Tourenplanung" ‚Üí "Einsatzplanung" umbenannt
- ‚úÖ Neue Sub-Tab-Struktur:
  ```
  Einsatzplanung
  ‚îú‚îÄ‚îÄ Tourenplanung (existing)
  ‚îî‚îÄ‚îÄ Schichtplanung (NEW!)
  ```

#### **B) BrowoKo_ShiftPlanningTab** (`/components/BrowoKo_ShiftPlanningTab.tsx`)
**Features:**
- ‚úÖ Sub-Tabs: Standort | Abteilung | Spezialisierung
- ‚úÖ Links: Mini-Kalender + Team/Mitarbeiter Accordion
- ‚úÖ Rechts: Wochenansicht Timeline
- ‚úÖ Filter: Standort, Abteilung, Spezialisierung Dropdowns
- ‚úÖ Team Accordion mit Member Count
- ‚úÖ Drag & Drop Integration (react-dnd)

#### **C) BrowoKo_ShiftTimeline** (`/components/BrowoKo_ShiftTimeline.tsx`)
**Features:**
- ‚úÖ Wochenansicht (Mo-So)
- ‚úÖ Timeline: 7:00-19:00 (12 Stunden)
- ‚úÖ Hour Grid Lines
- ‚úÖ Droppable Day Columns
- ‚úÖ Farbcodierte Schichtbl√∂cke
- ‚úÖ Dynamische Blockpositionierung nach Zeit

#### **D) BrowoKo_DraggableUser** (`/components/BrowoKo_DraggableUser.tsx`)
**Features:**
- ‚úÖ Draggable User Cards
- ‚úÖ Avatar mit Initialen
- ‚úÖ Spezialisierung anzeigen
- ‚úÖ "Geplant" Badge wenn Schicht existiert

#### **E) BrowoKo_DraggableShiftBlock** (`/components/BrowoKo_DraggableShiftBlock.tsx`)
**Features:**
- ‚úÖ Draggable Shift Blocks
- ‚úÖ Dynamischer Display Value (Standort/Abteilung/Spezialisierung)
- ‚úÖ Farbcodierung nach Spezialisierung
- ‚úÖ Zeit-Anzeige (Start - End)
- ‚úÖ Avatar im Block

#### **F) BrowoKo_MiniCalendar** (`/components/BrowoKo_MiniCalendar.tsx`)
**Features:**
- ‚úÖ Monatsansicht mit Wochenauswahl
- ‚úÖ Previous/Next Month Navigation
- ‚úÖ Week Selection Highlighting
- ‚úÖ Today Indicator (Ring)

---

### **3. FARBCODIERUNG**

**Spezialisierungen ‚Üí Farben:**
```typescript
'Baustelle' ‚Üí bg-orange-400
'BACKSTUBE' ‚Üí bg-orange-500
'GEM√úSE' ‚Üí bg-purple-400
'SCHUMIB√ÑCKER ZONE' ‚Üí bg-yellow-400
'NETZWERKRAUM-APPLE' ‚Üí bg-blue-400
// Andere: Hash-basiert (pink, indigo, green, red, teal)
```

---

### **4. DRAG & DROP SYSTEM**

**User ‚Üí Timeline:**
```tsx
<DraggableUser user={user} />
‚Üí Drag auf Timeline
‚Üí Opens CreateShiftDialog (TODO)
```

**Shift Block verschieben:**
```tsx
<DraggableShiftBlock shift={shift} />
‚Üí Drag auf andere Zeit/Tag
‚Üí Updates shift (TODO)
```

---

## üìã **DEPLOYMENT ANLEITUNG:**

### **SCHRITT 1: SQL MIGRATION**

```bash
# In Supabase SQL Editor ausf√ºhren:
1. √ñffne Supabase Dashboard
2. Gehe zu "SQL Editor"
3. Kopiere GESAMTEN Inhalt von: v4.12.0_SCHICHTPLANUNG_MIGRATION.sql
4. Paste in SQL Editor
5. Klicke "Run"
6. Warte auf Success Messages
```

**Expected Output:**
```
‚úÖ Added specialization column to users table
‚úÖ Added location_id column to shifts table
‚úÖ Added department_id column to shifts table
‚úÖ Added specialization column to shifts table
‚úÖ Created trigger to sync organigram specialization to users
‚úÖ Synced existing organigram specializations to users
‚úÖ SCHICHTPLANUNG MIGRATION v4.12.0 COMPLETE!
```

---

### **SCHRITT 2: SHIFTS TABLE ERSTELLEN**

**WICHTIG:** Wenn `shifts` table noch nicht existiert:

```bash
# Zuerst CREATE_SHIFTS_TABLE.sql ausf√ºhren!
1. √ñffne Supabase SQL Editor
2. Kopiere Inhalt von: CREATE_SHIFTS_TABLE.sql
3. Paste in SQL Editor
4. Klicke "Run"
5. DANN erst v4.12.0_SCHICHTPLANUNG_MIGRATION.sql ausf√ºhren!
```

---

### **SCHRITT 3: FRONTEND DEPLOYMENT**

```bash
# Keine Extra-Schritte n√∂tig!
# Alle Komponenten sind bereits in Codebase
# Bei n√§chstem Build werden sie automatisch deployed
```

---

## üß™ **TESTEN:**

### **Test 1: Datenbank**
```sql
-- Pr√ºfe users.specialization
SELECT id, first_name, last_name, specialization 
FROM users 
WHERE specialization IS NOT NULL
LIMIT 5;

-- Pr√ºfe shifts columns
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'shifts'
ORDER BY ordinal_position;

-- Pr√ºfe Trigger
SELECT trigger_name, event_manipulation, event_object_table
FROM information_schema.triggers
WHERE trigger_name = 'trigger_sync_organigram_specialization';
```

### **Test 2: Frontend**
1. Login als Admin/HR
2. Gehe zu: **Field Verwaltung**
3. Tab sollte hei√üen: **"Einsatzplanung"** (nicht mehr "Tourenplanung")
4. Klicke auf **"Einsatzplanung"**
5. Sieh Sub-Tabs: **Tourenplanung** | **Schichtplanung**
6. Klicke auf **"Schichtplanung"**
7. Sieh:
   - Sub-Tabs: Standort | Abteilung | Spezialisierung
   - Links: Mini-Kalender + Team Accordion
   - Rechts: Wochenansicht Timeline

### **Test 3: Drag & Drop**
1. In Schichtplanung Tab
2. Klappe Team-Accordion auf
3. Ziehe einen User mit Maus
4. Lasse User auf Timeline los
5. Console sollte zeigen: "Drop user: ..."

---

## üöß **TODO - NEXT STEPS:**

### **Priority 1: CreateShiftDialog**
```tsx
// /components/BrowoKo_CreateShiftDialog.tsx
- User ausw√§hlen
- Standort dropdown
- Abteilung dropdown
- Spezialisierung dropdown
- Start/End Zeit Picker
- Notizen Textarea
- Speichern ‚Üí POST /api/shifts
```

### **Priority 2: Edge Function Integration**
```typescript
// /supabase/functions/BrowoKoordinator-Schichtplanung/index.ts
GET /shifts?date=2024-11-01&team_id=xxx
POST /shifts ‚Üí Create
PUT /shifts/:id ‚Üí Update (f√ºr Drag & Drop!)
DELETE /shifts/:id
```

### **Priority 3: Validierung**
- √úberlappungs-Check (User kann nicht 2 Schichten zur gleichen Zeit)
- Max. Stunden pro Woche
- Ruhezeiten (min. 11h zwischen Schichten)
- Urlaub-Check (User im Urlaub kann keine Schicht bekommen)

### **Priority 4: Features**
- Schicht bearbeiten (Click auf Block)
- Schicht l√∂schen (Delete Confirmation)
- Bulk-Operationen (Woche kopieren)
- Wiederholungen (Jeden Montag 8-16h)
- Export (PDF/Excel)

### **Priority 5: Real Data**
- Supabase Integration (ersetze Mock Data)
- Load Teams from API
- Load Users from API
- Load Shifts from API
- Load Locations from API
- Load Departments from API

---

## üìä **ARCHITEKTUR:**

### **Datenfluss:**

```
Organigram Canvas (Admin bearbeitet Node)
  ‚Üì
UPDATE organigram_nodes SET specialization = 'BACKSTUBE'
  ‚Üì
TRIGGER: sync_organigram_specialization_to_user()
  ‚Üì
UPDATE users SET specialization = 'BACKSTUBE'
  ‚Üì
Frontend liest users.specialization
  ‚Üì
Schichtplanung zeigt Spezialisierung in Filters + Blocks
```

### **Hierarchie:**

```
Standort: Berlin (location)
  ‚îî‚îÄ‚îÄ Abteilung: Fahrer (department)
      ‚îî‚îÄ‚îÄ Spezialisierung: Baustelle (specialization)
          ‚îî‚îÄ‚îÄ Team: Fahrer Berlin (team)
              ‚îî‚îÄ‚îÄ Mitarbeiter: Max Mustermann (user)
```

### **Shift Display Logic:**

```typescript
if (viewMode === 'location') {
  displayValue = shift.location?.name || user.location?.name
} else if (viewMode === 'department') {
  displayValue = shift.department?.name || user.department
} else {
  displayValue = shift.specialization || user.specialization
}
```

---

## üé® **DESIGN SYSTEM:**

### **Colors:**
- Primary: Blue (#3B82F6)
- Background: Gray-50 (#F9FAFB)
- Borders: Gray-200 (#E5E7EB)
- Text: Gray-900 (#111827)

### **Schicht-Farben:**
- Orange: Baustelle, BACKSTUBE
- Purple: GEM√úSE
- Yellow: SCHUMIB√ÑCKER ZONE
- Blue: NETZWERKRAUM-APPLE
- Auto: Hash-basiert f√ºr andere

### **Spacing:**
- Timeline Hour Height: 80px
- Timeline Hours: 12 (7:00-19:00)
- Day Column Min Width: 800px (scrollable)
- Sidebar Width: 300px

---

## üîß **TROUBLESHOOTING:**

### **Problem: "shifts table does not exist"**
**L√∂sung:**
```bash
# F√ºhre zuerst CREATE_SHIFTS_TABLE.sql aus!
# Dann v4.12.0_SCHICHTPLANUNG_MIGRATION.sql
```

### **Problem: "column specialization already exists"**
**L√∂sung:**
```sql
-- Migration ist idempotent, einfach ignorieren
-- Oder manuell l√∂schen:
ALTER TABLE users DROP COLUMN IF EXISTS specialization CASCADE;
-- Dann Migration erneut ausf√ºhren
```

### **Problem: "Drag & Drop funktioniert nicht"**
**Check:**
1. react-dnd installiert? (sollte automatisch sein)
2. HTML5Backend verwendet?
3. DndProvider umschlie√üt Component?
4. Console Errors?

### **Problem: "Timeline zeigt keine Schichten"**
**Check:**
1. Mock Data vorhanden? (shifts array)
2. Datum korrekt? (format: 'yyyy-MM-dd')
3. Zeit korrekt? (format: 'HH:mm')
4. User IDs stimmen √ºberein?

---

## üìù **VERSION HISTORY:**

### **v4.12.0** - Schichtplanung System
- ‚úÖ SQL Migration (users.specialization + shifts extensions)
- ‚úÖ Organigram ‚Üí User Sync Trigger
- ‚úÖ FieldManagementScreen Refactoring
- ‚úÖ BrowoKo_ShiftPlanningTab (Main Component)
- ‚úÖ BrowoKo_ShiftTimeline (Timeline Component)
- ‚úÖ BrowoKo_DraggableUser (Drag Source)
- ‚úÖ BrowoKo_DraggableShiftBlock (Drag Source)
- ‚úÖ BrowoKo_MiniCalendar (Week Selection)
- ‚úÖ Drag & Drop Integration (react-dnd)
- ‚úÖ Sub-Tabs: Standort | Abteilung | Spezialisierung
- ‚úÖ Filter System
- ‚úÖ Farbcodierung
- ‚è≥ CreateShiftDialog (TODO)
- ‚è≥ Edge Function Integration (TODO)
- ‚è≥ Validierung (TODO)

---

## üöÄ **READY TO USE:**

**Nach Deployment kannst du:**
1. ‚úÖ Einsatzplanung Tab √∂ffnen
2. ‚úÖ Schichtplanung Sub-Tab √∂ffnen
3. ‚úÖ Zwischen Standort/Abteilung/Spezialisierung wechseln
4. ‚úÖ Woche mit Mini-Kalender ausw√§hlen
5. ‚úÖ Teams aufklappen
6. ‚úÖ Mitarbeiter sehen
7. ‚úÖ User auf Timeline ziehen (Console Log)
8. ‚è≥ Schichten erstellen (braucht Dialog)
9. ‚è≥ Schichten verschieben (braucht API)

**Status:** 60% Complete (UI/UX fertig, Backend TODO)

---

## üí° **N√ÑCHSTER CALL:**

**Wenn du bereit bist f√ºr Phase 2:**
1. CreateShiftDialog implementieren
2. Edge Function erstellen
3. Real Data Integration
4. Validierung hinzuf√ºgen
5. Advanced Features (Copy Week, Recurring Shifts, etc.)

**Sag Bescheid wenn du weitermachen willst!** üöÄ
