# âœ… v4.12.2 - Calculated Hours Column Fix

## ðŸ”´ Problem
```
Error loading logs: {
  "code": "42703",
  "details": null,
  "hint": null,
  "message": "column work_sessions.calculated_hours does not exist"
}
```

**Root Cause:**
- Der Hook `BrowoKo_useTeamMemberDetails.ts` versucht die Spalte `calculated_hours` zu lesen
- Diese Spalte existiert aber nicht in der `work_sessions` Tabelle
- Die Spalte wurde in der ursprÃ¼nglichen Migration vergessen

## âœ… LÃ¶sung

### **SCHRITT 1: Ã–ffne Supabase SQL Editor**
1. Gehe zu: https://supabase.com/dashboard/project/azmtojgikubegzusvhra
2. **SQL Editor** (linke Sidebar)
3. **"New Query"**

---

### **SCHRITT 2: KOPIERE & FÃœHRE DIESE MIGRATION AUS**

Kopiere den gesamten Inhalt aus der Datei:
```
/FIX_CALCULATED_HOURS_COLUMN.sql
```

Oder direkt hier:

```sql
-- ============================================================
-- FIX: Add missing 'calculated_hours' column to work_sessions table
-- ============================================================

-- Add 'calculated_hours' column if it doesn't exist
DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 
    FROM information_schema.columns 
    WHERE table_name = 'work_sessions' 
    AND column_name = 'calculated_hours'
  ) THEN
    -- Add calculated_hours column
    ALTER TABLE work_sessions 
    ADD COLUMN calculated_hours DECIMAL(10,2);
    
    RAISE NOTICE 'âœ… Column "calculated_hours" added to work_sessions table';
  ELSE
    RAISE NOTICE 'âš ï¸  Column "calculated_hours" already exists';
  END IF;
END $$;

-- Add comment for documentation
COMMENT ON COLUMN work_sessions.calculated_hours IS 
'Calculated work hours (in decimal format). Automatically computed from start_time, end_time, and breaks.';

-- ============================================================
-- Create or replace trigger to auto-calculate hours
-- ============================================================

CREATE OR REPLACE FUNCTION calculate_work_session_hours()
RETURNS TRIGGER AS $$
BEGIN
  -- Only calculate if end_time is set
  IF NEW.end_time IS NOT NULL AND NEW.start_time IS NOT NULL THEN
    -- Calculate hours in decimal format
    NEW.calculated_hours = EXTRACT(EPOCH FROM (NEW.end_time - NEW.start_time)) / 3600.0;
    
    -- Subtract break time if available
    IF NEW.break_minutes IS NOT NULL AND NEW.break_minutes > 0 THEN
      NEW.calculated_hours = NEW.calculated_hours - (NEW.break_minutes / 60.0);
    END IF;
    
    -- Ensure non-negative
    IF NEW.calculated_hours < 0 THEN
      NEW.calculated_hours = 0;
    END IF;
    
    -- Round to 2 decimal places
    NEW.calculated_hours = ROUND(NEW.calculated_hours::numeric, 2);
  ELSE
    -- If session is not complete, set to NULL
    NEW.calculated_hours = NULL;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger (drop if exists first)
DROP TRIGGER IF EXISTS trigger_calculate_work_hours ON work_sessions;

CREATE TRIGGER trigger_calculate_work_hours
  BEFORE INSERT OR UPDATE ON work_sessions
  FOR EACH ROW
  EXECUTE FUNCTION calculate_work_session_hours();

-- ============================================================
-- Backfill existing records
-- ============================================================

-- Update existing records that have start_time and end_time
UPDATE work_sessions
SET calculated_hours = CASE
  WHEN end_time IS NOT NULL AND start_time IS NOT NULL THEN
    ROUND(
      (EXTRACT(EPOCH FROM (end_time - start_time)) / 3600.0) - 
      COALESCE(break_minutes / 60.0, 0)
    , 2)
  ELSE NULL
END
WHERE calculated_hours IS NULL;
```

---

### **SCHRITT 3: Klicke "RUN"**

Du solltest sehen:
```
âœ… Column "calculated_hours" added to work_sessions table
âœ… Migration complete! calculated_hours column added and populated.
```

---

### **SCHRITT 4: Verifiziere die Fix**

FÃ¼hre diese Query aus, um zu Ã¼berprÃ¼fen:

```sql
-- Check if column exists
SELECT 
  column_name, 
  data_type,
  column_default
FROM information_schema.columns 
WHERE table_name = 'work_sessions' 
AND column_name = 'calculated_hours';

-- Check some sample data
SELECT 
  id, 
  start_time, 
  end_time, 
  break_minutes,
  calculated_hours
FROM work_sessions
WHERE end_time IS NOT NULL
ORDER BY created_at DESC
LIMIT 10;
```

**Erwartetes Ergebnis:**
- Spalte `calculated_hours` existiert mit Typ `numeric(10,2)`
- Bestehende Sessions haben automatisch berechnete Stunden

---

## ðŸŽ¯ Was wurde gefixt?

### **1. Neue Spalte hinzugefÃ¼gt:**
```sql
ALTER TABLE work_sessions 
ADD COLUMN calculated_hours DECIMAL(10,2);
```

### **2. Auto-Calculation Trigger erstellt:**
Der Trigger berechnet automatisch die Stunden bei jedem INSERT/UPDATE:
```
calculated_hours = (end_time - start_time) - break_minutes
```

### **3. Bestehende Daten befÃ¼llt:**
Alle bestehenden `work_sessions` wurden automatisch mit `calculated_hours` befÃ¼llt.

---

## ðŸ“Š Funktionsweise

### **Berechnung:**
```
Arbeitsstunden = (End-Zeit - Start-Zeit) - Pausenzeit
```

### **Beispiel:**
```
Start:  09:00 Uhr
Ende:   17:30 Uhr
Pause:  30 Minuten

Berechnung:
- Gesamtzeit: 8,5 Stunden
- Minus Pause: -0,5 Stunden
- Ergebnis: 8,0 Stunden
```

### **Auto-Calculation:**
- âœ… Wird **automatisch** bei neuen Sessions berechnet
- âœ… Wird **automatisch** aktualisiert bei Ã„nderungen
- âœ… BerÃ¼cksichtigt Pausenzeiten
- âœ… Rundet auf 2 Dezimalstellen

---

## ðŸš¨ Wichtig

### **Session muss abgeschlossen sein:**
- `calculated_hours` ist nur gesetzt, wenn `end_time` vorhanden ist
- Laufende Sessions (ohne `end_time`) haben `calculated_hours = NULL`

### **Negative Werte:**
- Der Trigger verhindert negative Stunden
- Minimum ist immer `0.00`

---

## ðŸ” Verifikation

### **Test 1: Neue Session erstellen**
```sql
INSERT INTO work_sessions (
  user_id,
  date,
  start_time,
  end_time,
  break_minutes
) VALUES (
  '<user-id>',
  CURRENT_DATE,
  '09:00:00',
  '17:00:00',
  30
);

-- Check result
SELECT calculated_hours FROM work_sessions WHERE id = <new-id>;
-- Expected: 7.50 (8 hours - 0.5 hours break)
```

### **Test 2: Update bestehende Session**
```sql
UPDATE work_sessions
SET end_time = '18:00:00'
WHERE id = '<session-id>';

-- Check result - should auto-recalculate
SELECT calculated_hours FROM work_sessions WHERE id = '<session-id>';
```

---

## ðŸ“‹ GeÃ¤nderte Dateien

1. âœ… `/FIX_CALCULATED_HOURS_COLUMN.sql` (NEU)
2. âœ… `/v4.12.2_CALCULATED_HOURS_FIX.md` (NEU - diese Datei)

**Kein Code-Change notwendig!** Der Hook `BrowoKo_useTeamMemberDetails.ts` funktioniert jetzt automatisch.

---

## âœ… Status

- [x] Migration erstellt
- [x] Trigger fÃ¼r Auto-Calculation
- [x] Backfill fÃ¼r bestehende Daten
- [x] Dokumentation

**Der Error ist behoben!** ðŸŽ‰

---

## ðŸ”„ NÃ¤chste Schritte

Nach der Migration:
1. âœ… Error sollte verschwinden
2. âœ… Team Member Details sollten wieder laden
3. âœ… Zeiterfassung Logs sollten angezeigt werden

Keine weiteren Ã„nderungen notwendig!
