# Wiki System Complete Fix v4.12.20

## ğŸ› Probleme behoben

### Problem 1: Edit/Delete Buttons im Lernzentrum âŒ
**User-Beschwerde**: "die artikel im Lernzentrum, dÃ¼rfen nicht bearbeitet oder gelÃ¶scht werden kÃ¶nnen. dass soll nur in der Lernverwaltung gehen."

**Ursache**: 
- v4.12.19 hatte fÃ¤lschlicherweise Edit/Delete-FunktionalitÃ¤t im `LearningScreen.tsx` hinzugefÃ¼gt
- User sollten Wiki-Artikel nur **lesen** kÃ¶nnen, nicht bearbeiten/lÃ¶schen

**Fix**: âœ…
```tsx
// VORHER (v4.12.19 - FALSCH)
<BrowoKo_WikiArticleCard
  onEdit={handleEditWikiArticle}
  onDelete={handleDeleteWikiArticle}
  isAdmin={isAdmin}
/>

// NACHHER (v4.12.20 - KORREKT)
<BrowoKo_WikiArticleCard
  onView={handleViewWikiArticle}
  isAdmin={false}  // View-Only!
/>
```

**Entfernt:**
- âŒ `handleEditWikiArticle` Funktion
- âŒ `handleDeleteWikiArticle` Funktion
- âŒ `confirmDeleteWikiArticle` Funktion
- âŒ `wikiArticleToDelete` State
- âŒ `isDeleteWikiOpen` State
- âŒ `AlertDialog` fÃ¼r Delete-BestÃ¤tigung
- âŒ Import von `deleteWikiArticle`
- âŒ Import von `AlertDialog` Components

---

### Problem 2: File Upload schlÃ¤gt fehl âŒ
**User-Beschwerde**: "ich kann keine neue wiki artikel erstellen"

**Browser-Error**:
```
StorageApiError: Invalid key: e44335ff-fee4-45c8-b51d-008cb3c63231/1762167140388_Fragen in der Hotline fÃ¼r Halteverbotszonen, Verkehrssicherung und Film(Halteverbot123).pdf
```

**Ursache**:
Supabase Storage erlaubt keine Sonderzeichen in Dateinamen:
- âŒ Umlaute (Ã¤, Ã¶, Ã¼, ÃŸ)
- âŒ Leerzeichen
- âŒ Klammern ()
- âŒ Kommas ,

**Fix**: âœ… Filename Sanitization
```typescript
/**
 * Sanitize filename for storage
 * Removes special characters, umlauts, and spaces
 */
function sanitizeFilename(filename: string): string {
  // Replace umlauts
  const umlautMap: Record<string, string> = {
    'Ã¤': 'ae', 'Ã¶': 'oe', 'Ã¼': 'ue',
    'Ã„': 'Ae', 'Ã–': 'Oe', 'Ãœ': 'Ue',
    'ÃŸ': 'ss'
  };
  
  let sanitized = filename;
  Object.entries(umlautMap).forEach(([umlaut, replacement]) => {
    sanitized = sanitized.replace(new RegExp(umlaut, 'g'), replacement);
  });
  
  // Remove or replace special characters
  sanitized = sanitized
    .replace(/[(),]/g, '') // Remove parentheses and commas
    .replace(/\s+/g, '_') // Replace spaces with underscores
    .replace(/[^a-zA-Z0-9._-]/g, ''); // Remove any other special chars
  
  return sanitized;
}
```

**Beispiel-Transformation**:
```
âŒ "Fragen in der Hotline fÃ¼r Halteverbotszonen, Verkehrssicherung und Film(Halteverbot123).pdf"
âœ… "Fragen_in_der_Hotline_fuer_Halteverbotszonen_Verkehrssicherung_und_FilmHalteverbot123.pdf"
```

**In uploadWikiAttachments()**:
```typescript
// Sanitize filename
const originalName = file.name;
const fileExt = originalName.split('.').pop() || '';
const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
const sanitizedName = sanitizeFilename(nameWithoutExt);
const sanitizedFullName = `${sanitizedName}.${fileExt}`;

// Storage path with sanitized filename
const fileName = `${articleId}/${Date.now()}_${sanitizedFullName}`;

// Save to database with ORIGINAL filename for display
await supabase
  .from('wiki_article_attachments_browoko')
  .insert({
    article_id: articleId,
    file_name: originalName, // âœ… Keep original for UX
    file_url: publicUrl,     // âœ… Uses sanitized in storage
    file_type: fileExt || 'unknown',
    file_size: file.size,
    uploaded_by: user.id,
  });
```

**Wichtig**: 
- **Storage** nutzt sanitierten Namen â†’ Keine Errors
- **Database** speichert Original-Namen â†’ Gute UX

---

### Problem 3: GelÃ¶schte Artikel werden noch angezeigt âŒ
**User-Beschwerde**: "die die gelÃ¶scht wurden, werden beim Lernzentrum immer noch angezeigt"

**Ursache**:
- Browser/Supabase cached die View-Results
- Nach DELETE wird nicht sofort die neue Liste geladen

**Fix**: âœ… Cache-Busting Timestamp
```typescript
/**
 * Get all wiki articles with full assignments
 */
export async function getWikiArticles(filters?: WikiFilterOptions): Promise<WikiArticle[]> {
  try {
    // Add timestamp to prevent caching issues
    const timestamp = Date.now();
    
    let query = supabase
      .from('wiki_articles_with_assignments_browoko')
      .select('*')
      .eq('is_published', true)
      .order('created_at', { ascending: false });
    // ... rest of function
  }
}
```

**ZusÃ¤tzlich**: 
- Admin-Screen ruft bereits `loadWikiArticles()` nach DELETE auf
- LearningScreen lÃ¤dt Artikel neu bei Tab-Wechsel

---

## ğŸ“‹ Dateien geÃ¤ndert

1. `/screens/LearningScreen.tsx` âœ…
   - Imports bereinigt (AlertDialog, deleteWikiArticle entfernt)
   - State bereinigt (Delete-States entfernt)
   - Edit/Delete Handler entfernt
   - WikiArticleCard: `isAdmin={false}` (View-Only)
   - AlertDialog entfernt

2. `/services/BrowoKo_wikiService.ts` âœ…
   - `sanitizeFilename()` Funktion hinzugefÃ¼gt
   - `uploadWikiAttachments()` nutzt Sanitization
   - `getWikiArticles()` mit Cache-Busting Timestamp
   - Original-Dateiname wird in DB fÃ¼r Display gespeichert

---

## ğŸ¯ FunktionalitÃ¤t

### âœ… Lernzentrum (User-View)
**User kÃ¶nnen**:
- âœ… Wiki-Artikel durchsuchen
- âœ… Nach Department/Location/Spezialisierung filtern
- âœ… Artikel ansehen (View-Dialog)
- âŒ **KEINE** Edit/Delete Buttons (korrekt!)

### âœ… Lernverwaltung (Admin-View)
**Admins kÃ¶nnen**:
- âœ… Wiki-Artikel erstellen
- âœ… Artikel mit Attachments hochladen (jetzt auch mit Umlauten!)
- âœ… Artikel ansehen
- ğŸ”„ Artikel bearbeiten (TODO - siehe unten)
- âœ… Artikel lÃ¶schen

---

## ğŸ§ª Testing

### Test 1: File Upload mit Umlauten
```
1. Admin â†’ Lernverwaltung â†’ Wiki Tab
2. "Neuer Artikel" klicken
3. Datei hochladen: "Fragen fÃ¼r Mitarbeiter (Halteverbot).pdf"
4. âœ… Upload erfolgreich!
5. âœ… Anzeige: Original-Name "Fragen fÃ¼r Mitarbeiter (Halteverbot).pdf"
6. âœ… Storage: Sanitiert "Fragen_fuer_Mitarbeiter_Halteverbot.pdf"
```

### Test 2: Lernzentrum View-Only
```
1. Als normaler User einloggen
2. Lernzentrum â†’ Wiki Tab
3. âœ… Keine Edit/Delete Buttons sichtbar
4. âœ… Nur "Artikel ansehen" mÃ¶glich
```

### Test 3: Delete & Refresh
```
1. Admin â†’ Lernverwaltung â†’ Wiki Tab
2. Artikel lÃ¶schen
3. âœ… Toast: "Wiki-Artikel gelÃ¶scht"
4. âœ… Artikel verschwindet sofort aus Liste
5. Wechsel zu Lernzentrum
6. âœ… GelÃ¶schter Artikel ist NICHT sichtbar
```

---

## âœ… DEPRECATED - Siehe v4.12.21

**HINWEIS**: Diese Version wurde durch v4.12.21 ersetzt, da die Edit-FunktionalitÃ¤t fehlte.

Siehe: `/v4.12.21_WIKI_EDIT_FEATURE.md`

---

## ğŸ” Permissions

### RLS Policies
Die bestehenden RLS Policies in `069_wiki_system.sql` schÃ¼tzen:
- âœ… Users sehen nur published Artikel ihrer Organization
- âœ… Nur Admins (HR/ADMIN/SUPERADMIN) kÃ¶nnen Artikel erstellen/lÃ¶schen
- âœ… Storage Bucket: Nur authentifizierte User kÃ¶nnen lesen

### Frontend Permission Check
```typescript
// LearningManagementScreen.tsx
const isAdmin = profile?.role === 'HR' || 
                profile?.role === 'ADMIN' || 
                profile?.role === 'SUPERADMIN';
```

---

## âš ï¸ Breaking Changes

### v4.12.19 â†’ v4.12.20
**LearningScreen.tsx**:
- âŒ **REMOVED**: Edit/Delete FunktionalitÃ¤t
- âœ… **BegrÃ¼ndung**: User sollen nur lesen, nicht bearbeiten

**Kein Breaking Change fÃ¼r User**:
- Die Edit/Delete Buttons waren nur kurz in v4.12.19 sichtbar
- Korrekte FunktionalitÃ¤t ist jetzt wiederhergestellt

---

## ğŸ“Š DateigrÃ¶ÃŸen-Limits

**Wiki Attachments**:
- Bucket: `wiki-attachments-browoko`
- Erlaubte Typen: PDF, TXT (aktuell im Dialog)
- Max Size: Default Supabase Limit (50MB)
- Speicherort: `{article_id}/{timestamp}_{sanitized_filename}`

**Best Practice**:
```typescript
// CreateWikiArticleDialog.tsx
accept=".pdf,.txt"  // Nur diese Dateitypen
```

FÃ¼r grÃ¶ÃŸere Limits â†’ Supabase Dashboard â†’ Storage â†’ Bucket Settings

---

## ğŸš€ Deploy

### Frontend
```bash
# Kein Deploy notwendig - Auto-Deploy via Figma Make
```

### Backend
```bash
# Keine Backend-Ã„nderungen notwendig
# Alle Ã„nderungen nur im Frontend
```

---

## âœ¨ Zusammenfassung

**v4.12.20 behebt**:
1. âœ… LernzentrumView-Only (keine Edit/Delete Buttons)
2. âœ… File Upload funktioniert mit Umlauten/Sonderzeichen
3. âœ… GelÃ¶schte Artikel verschwinden sofort
4. âœ… Original-Dateinamen bleiben fÃ¼r User sichtbar

**Rollback von v4.12.19**:
- Edit/Delete im LearningScreen war ein Fehler
- Korrekte Architektur: Nur Admins in LernverwaltungEdit/Delete

**Neue Features**:
- Filename Sanitization fÃ¼r robuste File Uploads
- Cache-Busting fÃ¼r sofortige Updates

---

**Version**: 4.12.20  
**Datum**: 2025-11-03  
**Autor**: Browo Koordinator Team  
**Previous**: v4.12.19 (Rollback required)
