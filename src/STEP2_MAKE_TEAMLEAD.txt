DO $$
DECLARE
  v_team_id uuid;
  v_member_id uuid;
  v_teamlead_id uuid;
  v_member_email text := 'social@halterverbot123.de';
  v_teamlead_email text := 'content@halterverbot123.de';
BEGIN
  SELECT id INTO v_member_id FROM users WHERE email = v_member_email;
  SELECT id INTO v_teamlead_id FROM users WHERE email = v_teamlead_email;
  
  IF v_member_id IS NULL THEN
    RAISE EXCEPTION 'Member with email % not found!', v_member_email;
  END IF;
  
  IF v_teamlead_id IS NULL THEN
    RAISE EXCEPTION 'Teamlead with email % not found!', v_teamlead_email;
  END IF;
  
  SELECT team_id INTO v_team_id FROM team_members WHERE user_id = v_member_id LIMIT 1;
  
  IF v_team_id IS NULL THEN
    INSERT INTO teams (name, description)
    VALUES ('Standard Team', 'Automatisch erstelltes Team')
    ON CONFLICT DO NOTHING
    RETURNING id INTO v_team_id;
    
    IF v_team_id IS NULL THEN
      SELECT id INTO v_team_id FROM teams LIMIT 1;
    END IF;
    
    INSERT INTO team_members (team_id, user_id, role)
    VALUES (v_team_id, v_member_id, 'MEMBER')
    ON CONFLICT DO NOTHING;
  END IF;
  
  INSERT INTO team_members (team_id, user_id, role, priority_tag)
  VALUES (v_team_id, v_teamlead_id, 'TEAMLEAD', 1)
  ON CONFLICT (team_id, user_id) 
  DO UPDATE SET role = 'TEAMLEAD', priority_tag = 1;
  
  RAISE NOTICE '✅ SUCCESS!';
  RAISE NOTICE '✅ % is now TEAMLEAD (Primary) in team %', v_teamlead_email, v_team_id;
  RAISE NOTICE '✅ % is MEMBER in team %', v_member_email, v_team_id;
END $$;