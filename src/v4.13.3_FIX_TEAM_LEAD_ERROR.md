# üîß v4.13.3 - Team Lead Column Error Fix

## ‚ùå Problem
```
ERROR: 42703: column t.team_lead_id does not exist
```

Die Migration `v4.13.3_DEPLOY_NOW.sql` referenziert eine **nicht existierende Spalte** `team_lead_id` in der `teams` Tabelle.

## üìä Database Schema Analyse

### ‚ùå Falsche Annahme:
```sql
-- FALSCH - teams hat KEINE team_lead_id Spalte!
SELECT user_id FROM team_members tm
JOIN teams t ON t.id = tm.team_id
WHERE t.team_lead_id = auth.uid()
```

### ‚úÖ Korrektes Schema:
Die `teams` Tabelle hat **keine** `team_lead_id` Spalte:
```sql
CREATE TABLE public.teams (
  id UUID PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  organization_id UUID,
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
  -- KEINE team_lead_id Spalte!
);
```

Der **Team Lead** wird in der `team_members` Junction-Tabelle mit `is_lead = true` markiert:
```sql
CREATE TABLE public.team_members (
  team_id UUID REFERENCES teams(id),
  user_id UUID REFERENCES users(id),
  is_lead BOOLEAN DEFAULT false,  -- ‚Üê HIER ist der Team Lead!
  joined_at TIMESTAMPTZ,
  PRIMARY KEY (team_id, user_id)
);
```

## ‚úÖ L√∂sung

### Betroffene RLS Policy (Zeile 80-88):
```sql
-- ‚ùå ALTE (FEHLERHAFTE) VERSION:
CREATE POLICY "external_trainings_teamlead_read" ON external_trainings
  FOR SELECT
  USING (
    user_id IN (
      SELECT user_id FROM team_members tm
      JOIN teams t ON t.id = tm.team_id
      WHERE t.team_lead_id = auth.uid()  -- ‚ùå Column existiert nicht!
    )
  );
```

### ‚úÖ NEUE (KORRIGIERTE) VERSION:
```sql
-- ‚úÖ FIXED VERSION:
CREATE POLICY "external_trainings_teamlead_read" ON external_trainings
  FOR SELECT
  USING (
    user_id IN (
      SELECT tm.user_id 
      FROM team_members tm
      WHERE tm.team_id IN (
        SELECT team_id 
        FROM team_members 
        WHERE user_id = auth.uid() 
        AND is_lead = true  -- ‚úÖ Korrekte Team Lead Logik!
      )
    )
  );
```

## üöÄ QUICK FIX - Copy & Paste Ready!

### 1. Use Fixed Migration File
```bash
# ‚úÖ Benutze die korrigierte Migration:
v4.13.3_DEPLOY_NOW_FIXED.sql
```

### 2. Deploy in Supabase
1. **√ñffne** Supabase SQL Editor
2. **Kopiere** den kompletten Inhalt von `v4.13.3_DEPLOY_NOW_FIXED.sql`
3. **Execute** die Migration
4. **Verify** Success Message

### 3. Deploy Edge Function
```bash
supabase functions deploy BrowoKoordinator-Lernen --no-verify-jwt
```

## üìù Was wurde ge√§ndert?

| File | Change |
|------|--------|
| `v4.13.3_DEPLOY_NOW_FIXED.sql` | ‚úÖ Korrigierte Teamlead RLS Policy (Zeile 84-98) |
| Logik | `t.team_lead_id` ‚Üí `team_members.is_lead = true` |

## ‚úÖ Verification

Nach dem Deployment:

```sql
-- Test: Pr√ºfe ob Policy korrekt ist
SELECT 
  policyname, 
  polcmd, 
  polroles,
  qual 
FROM pg_policies 
WHERE tablename = 'external_trainings' 
AND policyname = 'external_trainings_teamlead_read';
```

Expected Output:
- Policy sollte `is_lead = true` benutzen
- Keine Referenz zu `team_lead_id`

## üéØ Status

- ‚úÖ **Migration korrigiert**: `v4.13.3_DEPLOY_NOW_FIXED.sql`
- ‚úÖ **Fehler identifiziert**: `t.team_lead_id` existiert nicht
- ‚úÖ **L√∂sung implementiert**: Verwendung von `team_members.is_lead = true`
- ‚è≥ **Deploy Pending**: Migration ausf√ºhren + Edge Function deployen

## üìå Next Steps

1. ‚úÖ Execute `v4.13.3_DEPLOY_NOW_FIXED.sql` in Supabase SQL Editor
2. ‚úÖ Deploy Edge Function: `supabase functions deploy BrowoKoordinator-Lernen --no-verify-jwt`
3. ‚úÖ Test Training Compliance Dashboard im Frontend
4. ‚úÖ Verify 404 Errors sind behoben
