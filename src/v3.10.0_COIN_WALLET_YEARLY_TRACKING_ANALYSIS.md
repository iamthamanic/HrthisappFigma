# ğŸ“Š COIN WALLET YEARLY TRACKING - SITUATIONSANALYSE

## ğŸ¯ **ANFORDERUNG:**

Das Coin Wallet Widget soll zeigen:
1. **Aktueller Coin-Stand** (current_balance) âœ… BEREITS VORHANDEN
2. **Gesamt verdiente Coins im Jahr** (yearly_earned) âŒ FEHLT
3. **Yearly Reset Logic** âŒ FEHLT

**Grund:** Das System resettet sich jedes Jahr - User sollen sehen wie viele Coins sie **dieses Jahr** verdient haben.

---

## ğŸ“‹ **AKTUELLE SITUATION:**

### **1. Coin Transactions Tabelle:**

```sql
CREATE TABLE public.coin_transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE,
  amount INTEGER NOT NULL,
  reason TEXT NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('EARNED', 'SPENT')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Was haben wir:**
- âœ… `amount` - Coin Betrag
- âœ… `type` - EARNED oder SPENT
- âœ… `created_at` - Timestamp
- âŒ **KEIN Yearly Reset Tracking!**

---

### **2. Current Balance Berechnung:**

```typescript
// gamificationStore.ts (Line 112-142)
loadCoinBalance: async (userId) => {
  const { data, error } = await supabase
    .from('coin_transactions')
    .select('amount, type')
    .eq('user_id', userId);

  const total_earned = data
    ?.filter(t => t.type === 'EARNED')
    .reduce((sum, t) => sum + t.amount, 0) || 0;

  const total_spent = data
    ?.filter(t => t.type === 'SPENT')
    .reduce((sum, t) => Math.abs(t.amount), 0) || 0;

  const current_balance = total_earned - total_spent;

  set({
    coinBalance: {
      total_earned,    // ALL TIME!
      total_spent,     // ALL TIME!
      current_balance, // CURRENT
    },
    coins: current_balance,
  });
}
```

**Problem:**
- `total_earned` ist **ALL TIME** - nicht nur dieses Jahr!
- Wir brauchen `yearly_earned` fÃ¼r 2025, 2026, etc.

---

### **3. Coin Wallet Widget:**

```typescript
// HRTHIS_CoinWalletWidget.tsx (Line 15-43)
export default function HRTHIS_CoinWalletWidget() {
  const { coins, loadCoinBalance } = useGamificationStore();
  
  const balance = coins ?? 0;
  const formattedBalance = balance.toLocaleString('de-DE');

  return (
    <div className="...">
      <Coins className="..." />
      <div className="flex flex-col">
        <span>Coins</span>
        <span>{formattedBalance}</span> {/* Nur Current Balance! */}
      </div>
    </div>
  );
}
```

**Was fehlt:**
- âŒ Yearly Earned Display
- âŒ "X Coins dieses Jahr verdient" Label

---

## ğŸ¯ **LÃ–SUNG: 2 ANSÃ„TZE**

### **OPTION 1: Query-Based (Empfohlen!)**

**Vorteile:**
- âœ… Keine Migrations nÃ¶tig
- âœ… Kein Yearly Reset Cron Job
- âœ… Funktioniert sofort
- âœ… Historische Daten bleiben verfÃ¼gbar

**Implementierung:**
```typescript
// Query coin_transactions WHERE created_at >= '2025-01-01'
const yearly_earned = data
  ?.filter(t => t.type === 'EARNED' && 
                new Date(t.created_at) >= new Date('2025-01-01'))
  .reduce((sum, t) => sum + t.amount, 0) || 0;
```

**Display:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸª™ Coins                â”‚
â”‚                         â”‚
â”‚ Aktuell: 1,250         â”‚ â† current_balance
â”‚ 2025: 3,500 verdient   â”‚ â† yearly_earned
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **OPTION 2: Stored Values (Komplexer)**

**ZusÃ¤tzliche Felder in `users` Tabelle:**
```sql
ALTER TABLE users ADD COLUMN coin_balance INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN yearly_coins_earned INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN yearly_reset_year INTEGER DEFAULT EXTRACT(YEAR FROM NOW());
```

**Cron Job fÃ¼r Yearly Reset:**
```sql
-- Every January 1st at 00:00
UPDATE users 
SET yearly_coins_earned = 0,
    yearly_reset_year = EXTRACT(YEAR FROM NOW())
WHERE yearly_reset_year < EXTRACT(YEAR FROM NOW());
```

**Vorteile:**
- âœ… Schnellere Queries (keine SUM() nÃ¶tig)
- âœ… Klare Datenstruktur

**Nachteile:**
- âŒ Migrations required
- âŒ Cron Job Setup
- âŒ Mehr KomplexitÃ¤t
- âŒ Data Sync Issues mÃ¶glich

---

## ğŸ’¡ **EMPFEHLUNG: OPTION 1**

**Warum?**
1. **Sofort einsatzbereit** - keine Migrations
2. **Historisch korrekt** - basiert auf tatsÃ¤chlichen Transaktionen
3. **Flexibel** - kann fÃ¼r beliebige Jahre abgefragt werden
4. **Einfach** - keine Sync-Logik nÃ¶tig

**Performance:**
- coin_transactions hat bereits Index: `idx_coin_transactions_user`
- Query mit `created_at >= '2025-01-01'` ist schnell
- Typischer User hat < 100 Transactions/Jahr

---

## ğŸ“Š **IMPLEMENTIERUNGS-PLAN:**

### **STEP 1: Extend CoinBalance Type**

```typescript
// types/database.ts
export interface CoinBalance {
  total_earned: number;        // All time
  total_spent: number;         // All time
  current_balance: number;     // Current coins
  yearly_earned: number;       // NEW: Coins earned THIS year
  yearly_spent: number;        // NEW: Coins spent THIS year
  current_year: number;        // NEW: Year (e.g., 2025)
}
```

---

### **STEP 2: Update loadCoinBalance()**

```typescript
// stores/gamificationStore.ts
loadCoinBalance: async (userId) => {
  const { data, error } = await supabase
    .from('coin_transactions')
    .select('amount, type, created_at')  // ADD created_at!
    .eq('user_id', userId);

  if (error) throw error;

  // Current year (e.g., 2025)
  const currentYear = new Date().getFullYear();
  const yearStart = new Date(`${currentYear}-01-01T00:00:00Z`);

  // ALL TIME
  const total_earned = data
    ?.filter(t => t.type === 'EARNED')
    .reduce((sum, t) => sum + t.amount, 0) || 0;

  const total_spent = data
    ?.filter(t => t.type === 'SPENT')
    .reduce((sum, t) => Math.abs(t.amount), 0) || 0;

  // THIS YEAR ONLY
  const yearly_earned = data
    ?.filter(t => t.type === 'EARNED' && new Date(t.created_at) >= yearStart)
    .reduce((sum, t) => sum + t.amount, 0) || 0;

  const yearly_spent = data
    ?.filter(t => t.type === 'SPENT' && new Date(t.created_at) >= yearStart)
    .reduce((sum, t) => Math.abs(t.amount), 0) || 0;

  const current_balance = total_earned - total_spent;

  set({
    coinBalance: {
      total_earned,
      total_spent,
      current_balance,
      yearly_earned,      // NEW!
      yearly_spent,       // NEW!
      current_year: currentYear, // NEW!
    },
    coins: current_balance,
  });
}
```

---

### **STEP 3: Update Coin Wallet Widget**

```typescript
// components/HRTHIS_CoinWalletWidget.tsx
export default function HRTHIS_CoinWalletWidget() {
  const { profile } = useAuthStore();
  const { coins, coinBalance, loadCoinBalance } = useGamificationStore();

  useEffect(() => {
    if (profile?.id) {
      loadCoinBalance(profile.id);
    }
  }, [profile?.id, loadCoinBalance]);

  const balance = coins ?? 0;
  const yearlyEarned = coinBalance?.yearly_earned ?? 0;
  const currentYear = coinBalance?.current_year ?? new Date().getFullYear();
  
  const formattedBalance = balance.toLocaleString('de-DE');
  const formattedYearly = yearlyEarned.toLocaleString('de-DE');

  return (
    <div className="flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-yellow-50 to-orange-50 border border-orange-200 rounded-lg">
      <Coins className="w-4 h-4 text-orange-600" />
      <div className="flex flex-col">
        {/* Current Balance */}
        <span className="text-xs text-gray-500 leading-none">Aktuell</span>
        <span className="text-sm font-semibold text-gray-900 leading-none mt-0.5">
          {formattedBalance} Coins
        </span>
        
        {/* Yearly Earned (Separator) */}
        <div className="h-px bg-orange-200 my-1" />
        
        {/* Yearly Stats */}
        <span className="text-xs text-gray-500 leading-none">
          {currentYear}: {formattedYearly} verdient
        </span>
      </div>
    </div>
  );
}
```

---

## ğŸ¨ **UI MOCKUP:**

### **Variante A: Compact (Empfohlen)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸª™  Aktuell                 â”‚
â”‚     1,250 Coins             â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚     2025: 3,500 verdient    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Variante B: Stacked**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸª™  Coins                    â”‚
â”‚                             â”‚
â”‚     Balance: 1,250          â”‚
â”‚     2025: 3,500 verdient    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Variante C: With Icon Split**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸª™  1,250  |  ğŸ“Š 3,500      â”‚
â”‚     Aktuell   2025 verdient â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… **SUCCESS CRITERIA:**

```
User Ã¶ffnet App:
âœ… Sieht aktuellen Coin-Stand (z.B. 1,250)
âœ… Sieht diesjÃ¤hrig verdiente Coins (z.B. 3,500 in 2025)
âœ… Widget zeigt automatisch richtiges Jahr an
âœ… Am 01.01.2026 startet yearly_earned bei 0
âœ… Alte Transactions bleiben erhalten
âœ… Performance bleibt gut (< 100ms)
```

---

## ğŸ§ª **TEST SCENARIOS:**

### **Scenario 1: Normal User**

```typescript
// Transactions:
// 2024-12-15: +500 Coins (Learning)
// 2025-01-05: +100 Coins (Achievement)
// 2025-01-10: -50 Coins (Shop)
// 2025-01-15: +200 Coins (Quiz)

// Expected Display (in 2025):
current_balance: 750  // 500 + 100 - 50 + 200
yearly_earned: 300    // 100 + 200 (only 2025!)
```

---

### **Scenario 2: New User**

```typescript
// Transactions:
// 2025-01-13: +100 Coins (Welcome Bonus)

// Expected Display:
current_balance: 100
yearly_earned: 100
```

---

### **Scenario 3: Year Rollover (Edge Case)**

```typescript
// Date: 2025-12-31 23:59
current_balance: 1000
yearly_earned: 5000

// Date: 2026-01-01 00:01 (after midnight)
current_balance: 1000  // Same!
yearly_earned: 0       // RESET! (no transactions in 2026 yet)
```

---

## ğŸš€ **DEPLOYMENT PLAN:**

### **Phase 1: Backend (gamificationStore)**
1. Update `CoinBalance` interface in types/database.ts
2. Update `loadCoinBalance()` in gamificationStore.ts
3. Test with console.logs

### **Phase 2: Frontend (Wallet Widget)**
1. Update `HRTHIS_CoinWalletWidget.tsx`
2. Add yearly display
3. Test UI layout

### **Phase 3: Testing**
1. Create test transactions across years
2. Verify calculations
3. Test year rollover

### **Phase 4: Production**
1. Deploy to production
2. Monitor performance
3. Collect user feedback

---

## ğŸ“ **ALTERNATIVE FEATURES (Future):**

### **Expanded Stats Dialog:**

```typescript
// Click on Wallet Widget â†’ Opens Dialog with full stats

<Dialog>
  <DialogTitle>Coin Statistiken</DialogTitle>
  
  <Card>
    <h3>Aktuell</h3>
    <p>1,250 Coins</p>
  </Card>
  
  <Card>
    <h3>2025</h3>
    <p>Verdient: 3,500</p>
    <p>Ausgegeben: 2,250</p>
    <p>Netto: +1,250</p>
  </Card>
  
  <Card>
    <h3>All Time</h3>
    <p>Gesamt verdient: 8,500</p>
    <p>Gesamt ausgegeben: 7,250</p>
  </Card>
  
  <Card>
    <h3>Top Earning Sources (2025)</h3>
    <ul>
      <li>Learning: 1,500 Coins</li>
      <li>Achievements: 1,200 Coins</li>
      <li>Quizzes: 800 Coins</li>
    </ul>
  </Card>
</Dialog>
```

---

## ğŸ’¡ **DESIGN CONSIDERATIONS:**

### **Widget Size:**

**Current Widget:** ~100px width (compact)
**New Widget:** ~140px width (more content)

**Make sure it fits in header without breaking layout!**

---

### **Responsive Behavior:**

```tsx
// Mobile: Stack vertically
<div className="flex flex-col">
  <span>1,250</span>
  <span>2025: 3,500</span>
</div>

// Desktop: Side by side
<div className="flex gap-4">
  <div>Aktuell: 1,250</div>
  <div>2025: 3,500</div>
</div>
```

---

## ğŸ¯ **NEXT STEPS:**

Welche Option willst du?

1. **OPTION A: Compact Widget (Empfohlen)**
   - Zeigt Balance + Yearly Earned
   - Minimal UI Changes
   - Schnell implementiert

2. **OPTION B: Extended Widget**
   - Zeigt Balance + Yearly Earned + Yearly Spent
   - Mehr Info, grÃ¶ÃŸerer Widget
   - Mehr UI Work

3. **OPTION C: Click-to-Expand**
   - Zeigt nur Balance im Header
   - Click Ã¶ffnet Dialog mit Full Stats
   - Beste UX fÃ¼r Power Users

**Sag mir welche Option du willst und ich implementiere es sofort!** ğŸš€
