# v4.12.31 - QUICK FIX: Bild Upload Error ğŸš¨

**Problem:** `new row violates row-level security policy`  
**Grund:** Bucket `wiki-images` fehlt  
**LÃ¶sung:** Migration 072 ausfÃ¼hren (1 Minute)

---

## âš¡ Quick Fix (Copy & Paste)

### âš ï¸ WICHTIG: Syntax Error Fix!

**Problem:** `IF NOT EXISTS` wird bei `CREATE POLICY` nicht unterstÃ¼tzt  
**LÃ¶sung:** `DROP POLICY IF EXISTS` + `CREATE POLICY`

### Schritt 1: SQL ausfÃ¼hren

```sql
-- COPY & PASTE in Supabase SQL Editor
-- =====================================================
-- WIKI IMAGES BUCKET - FIXED VERSION
-- =====================================================

-- Step 1: Bucket erstellen
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'wiki-images',
  'wiki-images',
  true,
  5242880, -- 5MB
  ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp']
)
ON CONFLICT (id) DO NOTHING;

-- Step 2: Alte Policies lÃ¶schen (falls vorhanden)
DROP POLICY IF EXISTS "Public Access" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can upload wiki images" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can delete wiki images" ON storage.objects;

-- Step 3: Neue Policies erstellen
CREATE POLICY "Public Access"
ON storage.objects FOR SELECT
USING ( bucket_id = 'wiki-images' );

CREATE POLICY "Authenticated users can upload wiki images"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'wiki-images' 
  AND auth.role() = 'authenticated'
);

CREATE POLICY "Authenticated users can delete wiki images"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'wiki-images' 
  AND auth.role() = 'authenticated'
);

-- Step 4: Verifizieren
SELECT 
  'wiki-images Bucket erfolgreich erstellt! âœ…' AS status,
  (SELECT COUNT(*) FROM storage.buckets WHERE name = 'wiki-images') AS bucket_exists,
  (SELECT COUNT(*) FROM pg_policies WHERE tablename = 'objects' AND policyname LIKE '%wiki%') AS policies_count;
```

### Schritt 2: Verifizieren

```sql
-- Check ob Bucket existiert
SELECT * FROM storage.buckets WHERE name = 'wiki-images';
```

**Erwartung:** Eine Zeile mit `name = 'wiki-images'`, `public = true`

### Schritt 3: Testen

1. Wiki-Artikel Ã¶ffnen/erstellen
2. Bild-Button klicken
3. Bild auswÃ¤hlen
4. Upload klicken
5. âœ… Sollte jetzt funktionieren!

---

## ğŸ” Was wurde geÃ¤ndert?

### Frontend (v4.12.31)

**Entfernt:**
- âŒ Auto-Create Bucket Logik (verursachte RLS Error)

**HinzugefÃ¼gt:**
- âœ… File Type Validation (nur JPG, PNG, GIF, WebP)
- âœ… File Size Validation (max 5MB)
- âœ… Bessere Error Messages

**Code:**
```typescript
// Validation VOR Upload
if (!allowedTypes.includes(imageFile.type)) {
  toast.error('Nur JPG, PNG, GIF und WebP Dateien sind erlaubt');
  return;
}

if (imageFile.size > maxSize) {
  toast.error('Datei ist zu groÃŸ (max. 5MB)');
  return;
}
```

---

## ğŸ› Troubleshooting

### Error: "Bucket not found"
â†’ Migration 072 noch nicht ausgefÃ¼hrt  
â†’ Siehe Schritt 1 oben

### Error: "Nur JPG, PNG... erlaubt"
â†’ Falsche Datei ausgewÃ¤hlt (z.B. .pdf)  
â†’ Bitte Bilddatei auswÃ¤hlen

### Error: "Datei ist zu groÃŸ"
â†’ Bild > 5MB  
â†’ Bild komprimieren oder kleineres Bild wÃ¤hlen

### Error: "Upload fehlgeschlagen"
â†’ Browser Console Ã¶ffnen (F12)  
â†’ Error Message kopieren  
â†’ In Chat posten

---

## ğŸ“‹ Checklist

- [ ] SQL aus Schritt 1 in Supabase ausgefÃ¼hrt?
- [ ] Bucket existiert? (Schritt 2 ausgefÃ¼hrt)
- [ ] Browser Cache geleert? (Ctrl+Shift+R)
- [ ] Bild Upload getestet?

**4/4 = Ready! ğŸš€**

---

## ğŸ’¡ Virenscanner?

**Jetzt:** Basis Security (File Type + Size Validation)  
**SpÃ¤ter:** Virenscanner via ClamAV oder VirusTotal API

FÃ¼r Prototyp/MVP ist die aktuelle LÃ¶sung ausreichend.  
Virenscanner kann spÃ¤ter hinzugefÃ¼gt werden bei Bedarf.

---

**Status:** âœ… Fixed in v4.12.31  
**Zeit:** ~1 Minute  
**Schwierigkeit:** â­ Easy (Copy & Paste)
