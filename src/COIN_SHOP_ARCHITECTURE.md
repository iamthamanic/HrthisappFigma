# ğŸ—ï¸ COIN SHOP ARCHITECTURE (v3.8.0)

Visueller Ãœberblick Ã¼ber das komplette Coin-Shop System.

---

## ğŸ“Š SYSTEM ARCHITECTURE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     BENEFITS COIN SHOP                      â”‚
â”‚                         (v3.8.0)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         FRONTEND LAYER              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Shop  â”‚   â”‚  My    â”‚    â”‚  Admin   â”‚
   â”‚  Tab   â”‚   â”‚Benefitsâ”‚    â”‚Verwaltungâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚              â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       SERVICE LAYER (TypeScript)     â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ â€¢ getBenefitsWithPurchaseInfo()     â”‚
        â”‚ â€¢ purchaseBenefitWithCoins()        â”‚
        â”‚ â€¢ calculateUserCoinBalance()        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      DATABASE LAYER (Supabase)      â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Tables:                             â”‚
        â”‚  â€¢ benefits (extended)              â”‚
        â”‚  â€¢ coin_benefit_purchases (NEW)     â”‚
        â”‚  â€¢ coin_transactions                â”‚
        â”‚  â€¢ user_benefits                    â”‚
        â”‚                                     â”‚
        â”‚ Triggers:                           â”‚
        â”‚  â€¢ refund_coins_on_rejection()      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ PURCHASE FLOW DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  USER PURCHASE FLOW                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. USER INITIATES PURCHASE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  User   â”‚ â†’ Clicks "FÃ¼r 500 Coins kaufen"
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Purchase Dialog     â”‚
   â”‚ â€¢ Current Balance   â”‚
   â”‚ â€¢ Cost              â”‚
   â”‚ â€¢ New Balance       â”‚
   â”‚ â€¢ Approval Info     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ User confirms
        
2. VALIDATION & TRANSACTION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Service: purchaseBenefitWithCoins â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â†’ âœ“ Benefit exists?
        â”œâ”€â†’ âœ“ User has enough coins?
        â”œâ”€â†’ âœ“ Benefit available?
        â””â”€â†’ âœ“ Not already purchased?
        â”‚
        â–¼ All checks pass
        
3. COIN DEDUCTION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ coin_transactions    â”‚
   â”‚ INSERT:              â”‚
   â”‚  amount: -500        â”‚
   â”‚  type: SPENT         â”‚
   â”‚  reason: "Benefit..."â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
        
4. CREATE USER BENEFIT
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ user_benefits        â”‚
   â”‚ INSERT:              â”‚
   â”‚  status: PENDING or  â”‚
   â”‚          APPROVED    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
        
5. LOG PURCHASE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ coin_benefit_purchases â”‚
   â”‚ INSERT:                â”‚
   â”‚  coin_amount: 500      â”‚
   â”‚  purchased_at: NOW()   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
        
6. APPROVAL PATH
   
   A) instant_approval = true
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Status:  â”‚
      â”‚ APPROVED â”‚ â†’ User sees benefit immediately
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   B) requires_approval = true
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Status:  â”‚
      â”‚ PENDING  â”‚ â†’ Waits for admin
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   Admin    â”‚ â†’ Approves or Rejects
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â†’ APPROVED: Benefit active
           â”‚
           â””â”€â†’ REJECTED: Trigger fires
                    â”‚
                    â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Refund Trigger  â”‚
               â”‚ â€¢ Creates +500  â”‚
               â”‚   transaction   â”‚
               â”‚ â€¢ Type: EARNED  â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ DATABASE SCHEMA DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DATABASE SCHEMA                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      benefits       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                  â”‚â”€â”€â”€â”
â”‚ title               â”‚   â”‚
â”‚ description         â”‚   â”‚
â”‚ category            â”‚   â”‚
â”‚ coin_price â—„â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚ NEW: Coin Shop Fields
â”‚ purchase_type â—„â”€â”€â”€  â”‚   â”‚
â”‚ requires_approval   â”‚   â”‚
â”‚ instant_approval    â”‚   â”‚
â”‚ max_users           â”‚   â”‚
â”‚ current_users       â”‚   â”‚
â”‚ is_active           â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                          â”‚
                          â”‚ FK
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ coin_benefit_       â”‚   â”‚
â”‚     purchases       â”‚â—„â”€â”€â”˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                  â”‚
â”‚ user_id             â”‚â”€â”€â”€â”
â”‚ benefit_id          â”‚   â”‚
â”‚ coin_amount         â”‚   â”‚
â”‚ coin_transaction_id â”‚â”€â”€â”€â”¼â”€â”
â”‚ user_benefit_id     â”‚â”€â”€â”€â”¼â”€â”¼â”€â”
â”‚ purchased_at        â”‚   â”‚ â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚ â”‚
                          â”‚ â”‚ â”‚
                     FK   â”‚ â”‚ â”‚
                          â”‚ â”‚ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚ â”‚
â”‚  coin_transactions  â”‚â—„â”€â”€â”˜ â”‚ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚ â”‚
â”‚ id                  â”‚â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ user_id             â”‚       â”‚
â”‚ amount              â”‚       â”‚
â”‚ type (EARNED/SPENT) â”‚       â”‚
â”‚ reason              â”‚       â”‚
â”‚ created_at          â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                              â”‚
                         FK   â”‚
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   user_benefits     â”‚â—„â”€â”€â”€â”€â”€â”€â”˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                  â”‚
â”‚ user_id             â”‚
â”‚ benefit_id          â”‚
â”‚ status              â”‚ â—„â”€â”€â”€ Trigger watches this
â”‚ requested_at        â”‚
â”‚ approved_at         â”‚
â”‚ approved_by         â”‚
â”‚ rejection_reason    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ TRIGGER: refund_coins_on_rejection()
           â”‚ WHEN: status changes to REJECTED
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Creates    â”‚
    â”‚  +X Coins    â”‚
    â”‚ transaction  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ADMIN BENEFIT CONFIGURATION

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ADMIN BENEFIT CREATION FLOW                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Admin      â”‚
â”‚  clicks "New   â”‚
â”‚    Benefit"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Benefit Dialog                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Basic Info:                         â”‚
â”‚ â€¢ Title                             â”‚
â”‚ â€¢ Description                       â”‚
â”‚ â€¢ Category                          â”‚
â”‚ â€¢ Icon                              â”‚
â”‚                                     â”‚
â”‚ Availability:                       â”‚
â”‚ â€¢ Max Users                         â”‚
â”‚ â€¢ Eligibility (months)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“ COIN SHOP SECTION (NEW)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ [â—‹] Nur per Antrag                  â”‚
â”‚     â””â”€â†’ purchase_type = REQUEST_ONLYâ”‚
â”‚                                     â”‚
â”‚ [â—‹] Nur mit Coins kaufbar           â”‚
â”‚     â”œâ”€â†’ purchase_type = COINS_ONLY  â”‚
â”‚     â””â”€â†’ Shows Coin Price Input      â”‚
â”‚                                     â”‚
â”‚ [â¦¿] Beides mÃ¶glich                  â”‚
â”‚     â”œâ”€â†’ purchase_type = BOTH        â”‚
â”‚     â””â”€â†’ Shows Coin Price Input      â”‚
â”‚                                     â”‚
â”‚ If COINS_ONLY or BOTH:              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Coin-Preis: [___500____]    â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ [âœ“] Genehmigung erforderlichâ”‚    â”‚
â”‚ â”‚     (requires_approval)     â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚ If requires_approval = false:       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ [âœ“] Sofort verfÃ¼gbar        â”‚    â”‚
â”‚ â”‚     (instant_approval)      â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Benefit saved  â”‚
â”‚   in database   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›ï¸ USER INTERFACE ARCHITECTURE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BENEFITS SCREEN (User View)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tabs: [ğŸ›ï¸ Shop] [Meine Benefits] [Verwaltung] [Genehmig.]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ "Shop" selected
        
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Search: [__________________] [Filter: Alle Kategorien â–¼] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BENEFIT CARDS                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ğŸ¥ Gesundheit     500ğŸª™â”‚  â”‚ ğŸ Verpflegung    200ğŸª™â”‚     â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚      â”‚
â”‚  â”‚ Fitnessstudio-     â”‚  â”‚ Essenszuschuss      â”‚      â”‚
â”‚  â”‚ Mitgliedschaft     â”‚  â”‚                      â”‚      â”‚
â”‚  â”‚                      â”‚  â”‚ Premium Mahlzeiten  â”‚      â”‚
â”‚  â”‚ [Details ansehen]   â”‚  â”‚ im BÃ¼ro             â”‚      â”‚
â”‚  â”‚ [FÃ¼r 500 kaufen]    â”‚  â”‚ [Details ansehen]   â”‚      â”‚
â”‚  â”‚                      â”‚  â”‚ [FÃ¼r 200 kaufen]    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ğŸš— MobilitÃ¤t    5000ğŸª™â”‚  â”‚ ğŸ“š Weiterbildung  ANTRAG â”‚  â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚      â”‚
â”‚  â”‚ Firmenwagen         â”‚  â”‚ Konferenz-Ticket    â”‚      â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚      â”‚
â”‚  â”‚ Elektrofahrzeug fÃ¼r â”‚  â”‚ Externe Kurse und   â”‚      â”‚
â”‚  â”‚ private Nutzung     â”‚  â”‚ Events              â”‚      â”‚
â”‚  â”‚ [Details ansehen]   â”‚  â”‚ [Details ansehen]   â”‚      â”‚
â”‚  â”‚ [FÃ¼r 5000 kaufen]   â”‚  â”‚ [Jetzt anfordern]   â”‚      â”‚
â”‚  â”‚ [Jetzt anfordern]   â”‚  â”‚                      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Click "FÃ¼r 500 kaufen"
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      Purchase Confirmation Dialog     â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                       â”‚
        â”‚  ğŸ›ï¸ Benefit kaufen?                   â”‚
        â”‚                                       â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚  â”‚ ğŸ¥ Fitnessstudio-           â”‚     â”‚
        â”‚  â”‚    Mitgliedschaft           â”‚     â”‚
        â”‚  â”‚                             â”‚     â”‚
        â”‚  â”‚ Zugang zu Premium-Gym...    â”‚     â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚                                       â”‚
        â”‚  Dein Kontostand:      1,000 ğŸª™      â”‚
        â”‚  Kosten:                -500 ğŸª™      â”‚
        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
        â”‚  Neuer Kontostand:       500 ğŸª™      â”‚
        â”‚                                       â”‚
        â”‚  âš ï¸ Hinweis: Dieses Benefit muss     â”‚
        â”‚  noch von einem Admin genehmigt      â”‚
        â”‚  werden. Die Coins werden sofort     â”‚
        â”‚  abgezogen.                           â”‚
        â”‚                                       â”‚
        â”‚  [Abbrechen]  [Jetzt kaufen]         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ STATE MANAGEMENT

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               REACT STATE ARCHITECTURE                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BenefitsScreen (Main Component)
  â”‚
  â”œâ”€ State:
  â”‚  â”œâ”€ benefits: BenefitWithPurchaseInfo[]
  â”‚  â”‚   â””â”€ Contains:
  â”‚  â”‚       â€¢ Benefit data
  â”‚  â”‚       â€¢ user_coin_balance
  â”‚  â”‚       â€¢ can_purchase_with_coins
  â”‚  â”‚       â€¢ can_request
  â”‚  â”‚       â€¢ has_benefit
  â”‚  â”‚
  â”‚  â”œâ”€ purchaseDialogOpen: boolean
  â”‚  â””â”€ selectedPurchaseBenefit: BenefitWithPurchaseInfo | null
  â”‚
  â”œâ”€ Handlers:
  â”‚  â”œâ”€ handlePurchaseClick()
  â”‚  â”‚   â””â”€â†’ Opens Purchase Dialog
  â”‚  â”‚
  â”‚  â””â”€ handlePurchaseConfirm()
  â”‚      â”œâ”€â†’ Calls purchaseBenefitWithCoins()
  â”‚      â”œâ”€â†’ Shows success toast
  â”‚      â””â”€â†’ Reloads data
  â”‚
  â””â”€ Children:
     â”œâ”€ BenefitBrowseCard (foreach benefit)
     â”‚   â””â”€ Props: benefit, onPurchase, onRequest
     â”‚
     â””â”€ BenefitPurchaseDialog
         â””â”€ Props: benefit, open, onConfirm
```

---

## ğŸ” SECURITY ARCHITECTURE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY LAYERS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. DATABASE LEVEL (RLS)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Row Level Security Policies   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ â€¢ Users see own purchases     â”‚
   â”‚ â€¢ Admins see all in org       â”‚
   â”‚ â€¢ System can create purchases â”‚
   â”‚ â€¢ UNIQUE(user_id, benefit_id) â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. APPLICATION LEVEL (TypeScript)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Service Layer Validation      â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ â€¢ Balance check               â”‚
   â”‚ â€¢ Availability check          â”‚
   â”‚ â€¢ Duplicate check             â”‚
   â”‚ â€¢ Status validation           â”‚
   â”‚ â€¢ Auth.uid() verification     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. UI LEVEL (React)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Frontend Guards               â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ â€¢ Button disabled if no coins â”‚
   â”‚ â€¢ Warning if insufficient     â”‚
   â”‚ â€¢ Role-based rendering        â”‚
   â”‚ â€¢ Protected routes            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š DATA FLOW DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         COMPLETE DATA FLOW (Purchase to Refund)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. INITIAL LOAD
   Frontend
     â”‚
     â””â”€â†’ getBenefitsWithPurchaseInfo(orgId, userId)
           â”‚
           â”œâ”€â†’ Query: benefits
           â”œâ”€â†’ Query: coin_transactions (calculate balance)
           â””â”€â†’ Query: user_benefits (check existing)
           â”‚
           â””â”€â†’ Returns: BenefitWithPurchaseInfo[]
               â”‚
               â””â”€â†’ Frontend renders cards with coin prices

2. PURCHASE INITIATED
   User clicks "FÃ¼r 500 Coins kaufen"
     â”‚
     â””â”€â†’ purchaseBenefitWithCoins(benefitId, userId)
           â”‚
           â”œâ”€â†’ 1. Validate: benefit exists
           â”œâ”€â†’ 2. Validate: user has 500 coins
           â”œâ”€â†’ 3. Validate: benefit available
           â”œâ”€â†’ 4. Validate: not already purchased
           â”‚
           â”œâ”€â†’ 5. INSERT coin_transactions (-500, SPENT)
           â”œâ”€â†’ 6. INSERT user_benefits (PENDING/APPROVED)
           â”œâ”€â†’ 7. INSERT coin_benefit_purchases (audit)
           â””â”€â†’ 8. UPDATE benefits.current_users + 1
           â”‚
           â””â”€â†’ Success! User sees toast

3. APPROVAL FLOW (if requires_approval = true)
   Admin â†’ Genehmigungen Tab
     â”‚
     â”œâ”€â†’ Option A: APPROVE
     â”‚   â””â”€â†’ UPDATE user_benefits SET status = 'APPROVED'
     â”‚       â””â”€â†’ User sees benefit in "Meine Benefits"
     â”‚
     â””â”€â†’ Option B: REJECT
         â””â”€â†’ UPDATE user_benefits SET status = 'REJECTED'
               â”‚
               â””â”€â†’ TRIGGER: refund_coins_on_rejection()
                     â”‚
                     â”œâ”€â†’ SELECT coin_benefit_purchases
                     â”‚   WHERE user_benefit_id = X
                     â”‚
                     â””â”€â†’ INSERT coin_transactions
                         (+500, EARNED, 'Refund: ...')
                         â”‚
                         â””â”€â†’ User gets coins back!
```

---

## ğŸ¯ COMPONENT HIERARCHY

```
App
 â”‚
 â””â”€ BenefitsScreen
     â”‚
     â”œâ”€ Tabs
     â”‚   â”œâ”€ Shop
     â”‚   â”œâ”€ Meine Benefits
     â”‚   â”œâ”€ Verwaltung (Admin only)
     â”‚   â””â”€ Genehmigungen (Admin only)
     â”‚
     â”œâ”€ Shop Tab Content
     â”‚   â”œâ”€ Search Input
     â”‚   â”œâ”€ Category Filter
     â”‚   â””â”€ Benefits Grid
     â”‚       â””â”€ BenefitBrowseCard (foreach)
     â”‚           â”œâ”€ Coin Badge (if coin_price)
     â”‚           â”œâ”€ Title & Description
     â”‚           â”œâ”€ Details Button
     â”‚           â”œâ”€ Purchase Button (if can_purchase)
     â”‚           â””â”€ Request Button (if can_request)
     â”‚
     â””â”€ Dialogs
         â”œâ”€ BenefitRequestDialog (existing)
         â”œâ”€ BenefitPurchaseDialog â—„â”€â”€â”€ NEW!
         â”‚   â”œâ”€ Benefit Info
         â”‚   â”œâ”€ Balance Display
         â”‚   â”œâ”€ Cost Calculation
         â”‚   â”œâ”€ Approval Info Alert
         â”‚   â””â”€ Confirm Button
         â”‚
         â”œâ”€ BenefitApprovalDialog (Admin)
         â””â”€ BenefitDialog (Admin)
             â””â”€ Coin Shop Section â—„â”€â”€â”€ NEW!
                 â”œâ”€ Purchase Type Radio
                 â”œâ”€ Coin Price Input
                 â””â”€ Approval Toggles
```

---

## ğŸ† SUMMARY

Das Coin-Shop System ist eine **komplette End-to-End Implementation** mit:

âœ… **Database Layer** - RLS, Triggers, Audit Trail  
âœ… **Service Layer** - Validation, Purchase Logic, Balance Calc  
âœ… **UI Layer** - Shop Interface, Dialogs, Admin Controls  
âœ… **Security** - Multi-layer validation & authorization  
âœ… **Performance** - Optimized queries & indexes  
âœ… **Documentation** - Complete guides & diagrams  

**Ready for Production! ğŸš€**
