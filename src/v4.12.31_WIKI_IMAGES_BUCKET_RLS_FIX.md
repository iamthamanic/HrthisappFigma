# v4.12.31 - Wiki Images Bucket RLS Fix ğŸ”’

**Datum:** 4. November 2025  
**Status:** âœ… COMPLETE  
**Komponente:** `BrowoKo_RichTextEditor.tsx` + Migration 072  
**Priority:** ğŸ”¥ CRITICAL - Bild Upload funktioniert nicht!

---

## ğŸ› Problem

### User Error:
```
Creating wiki-images bucket...
POST https://...supabase.co/storage/v1/bucket 400 (Bad Request)
Bucket creation error: StorageApiError: new row violates row-level security policy
```

### Root Cause Analysis

**Problem 1: RLS Policy Violation**
- Frontend versucht, Bucket zu erstellen via `supabase.storage.createBucket()`
- Frontend hat **KEINE BERECHTIGUNG** zum Erstellen von Buckets
- Nur Service Role oder SQL Migrations kÃ¶nnen Buckets erstellen
- **RLS Policy verhindert Frontend-Bucket-Erstellung**

**Problem 2: Security Architecture**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FALSCHE ARCHITEKTUR                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend (User Session)                                     â”‚
â”‚    â†“                                                         â”‚
â”‚ supabase.storage.createBucket() âŒ                          â”‚
â”‚    â†“                                                         â”‚
â”‚ RLS Policy Check: "Ist User Superadmin?" â†’ NEIN â†’ ERROR    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RICHTIGE ARCHITEKTUR                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SQL Migration (Service Role) âœ…                             â”‚
â”‚    â†“                                                         â”‚
â”‚ CREATE BUCKET via INSERT INTO storage.buckets              â”‚
â”‚    â†“                                                         â”‚
â”‚ RLS Policy Check: Bypass (Service Role)                    â”‚
â”‚    â†“                                                         â”‚
â”‚ Bucket erstellt âœ…                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ LÃ¶sung v4.12.31

### 1. âŒ Entfernt: Auto-Create Logik im Frontend

**VORHER (v4.12.30.2):**
```typescript
// âŒ FALSCH: Frontend kann keine Buckets erstellen!
const { data: buckets } = await supabase.storage.listBuckets();
const bucketExists = buckets?.some(bucket => bucket.name === 'wiki-images');

if (!bucketExists) {
  console.log('Creating wiki-images bucket...');
  const { error: createError } = await supabase.storage.createBucket('wiki-images', {
    public: true,
    fileSizeLimit: 5242880
  });
  
  if (createError) {
    // RLS ERROR hier! âŒ
    toast.error('Bucket konnte nicht erstellt werden.');
    return;
  }
}
```

**NACHHER (v4.12.31):**
```typescript
// âœ… RICHTIG: Bucket MUSS bereits existieren (via Migration)
const { data: uploadData, error: uploadError } = await supabase.storage
  .from('wiki-images')
  .upload(filePath, imageFile);

if (uploadError) {
  if (uploadError.message.includes('Bucket not found')) {
    toast.error('Storage Bucket fehlt! Bitte fÃ¼hre Migration 072 aus.');
  }
}
```

---

### 2. âœ… HinzugefÃ¼gt: File Validation

**Security Layer im Frontend:**
```typescript
// FILE VALIDATION (vor Upload)
const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
const maxSize = 5 * 1024 * 1024; // 5MB

if (!allowedTypes.includes(imageFile.type)) {
  toast.error('Nur JPG, PNG, GIF und WebP Dateien sind erlaubt');
  return;
}

if (imageFile.size > maxSize) {
  toast.error('Datei ist zu groÃŸ (max. 5MB)');
  return;
}
```

**Warum wichtig?**
- âœ… Frontend-Validierung verhindert unnÃ¶tige Upload-Versuche
- âœ… User bekommt sofort Feedback (keine Wartezeit)
- âœ… Spart Bandwidth und Storage-Kosten
- âœ… Verhindert Upload von .exe, .zip, .pdf etc.

---

### 3. âœ… Bessere Error Messages

**VORHER:**
```typescript
if (uploadError) {
  toast.error(`Fehler beim Hochladen: ${uploadError.message}`);
}
```

**NACHHER:**
```typescript
if (uploadError) {
  // User-friendly error messages
  if (uploadError.message.includes('Bucket not found')) {
    toast.error('Storage Bucket fehlt! Bitte fÃ¼hre Migration 072 aus.');
  } else if (uploadError.message.includes('exceeds')) {
    toast.error('Datei ist zu groÃŸ');
  } else {
    toast.error(`Upload fehlgeschlagen: ${uploadError.message}`);
  }
}
```

**User Experience:**
- âŒ "StorageApiError: Bucket not found" â†’ User verwirrt
- âœ… "Storage Bucket fehlt! Bitte fÃ¼hre Migration 072 aus." â†’ User weiÃŸ was zu tun ist

---

## ğŸ“‹ Migration 072: Bucket erstellen

### âš ï¸ SYNTAX ERROR FIX REQUIRED!

**Problem:** Original Migration hat `IF NOT EXISTS` bei `CREATE POLICY` â†’ Syntax Error!  
**Fix:** Verwende die korrigierte Version mit `DROP + CREATE` Pattern.

**Datei (BROKEN):** `/supabase/migrations/072_create_wiki_images_bucket_QUICK_FIX.sql` âŒ  
**Datei (FIXED):** `/v4.12.31_COPY_PASTE_THIS_NOW.sql` âœ…

```sql
-- Bucket erstellen (idempotent)
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'wiki-images',
  'wiki-images',
  true, -- Public bucket fÃ¼r Bilder in Wiki-Artikeln
  5242880, -- 5MB limit
  ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp']
)
ON CONFLICT (id) DO NOTHING;

-- WICHTIG: DROP + CREATE Pattern (IF NOT EXISTS wird nicht unterstÃ¼tzt!)
DROP POLICY IF EXISTS "Public Access" ON storage.objects;
CREATE POLICY "Public Access"
ON storage.objects FOR SELECT
USING ( bucket_id = 'wiki-images' );

DROP POLICY IF EXISTS "Authenticated users can upload wiki images" ON storage.objects;
CREATE POLICY "Authenticated users can upload wiki images"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'wiki-images' 
  AND auth.role() = 'authenticated'
);

DROP POLICY IF EXISTS "Authenticated users can delete wiki images" ON storage.objects;
CREATE POLICY "Authenticated users can delete wiki images"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'wiki-images' 
  AND auth.role() = 'authenticated'
);
```

### Wie ausfÃ¼hren?

**Option 1: Supabase SQL Editor** (Empfohlen)
1. Supabase Dashboard Ã¶ffnen
2. SQL Editor
3. Inhalt von `072_create_wiki_images_bucket_QUICK_FIX.sql` einfÃ¼gen
4. "Run" klicken
5. âœ… BestÃ¤tigung: "wiki-images Bucket erfolgreich erstellt!"

**Option 2: Supabase CLI**
```bash
supabase db push
```

**Option 3: Manuell via UI**
1. Supabase Dashboard â†’ Storage
2. "New Bucket"
3. Name: `wiki-images`
4. Public: âœ… Yes
5. File size limit: 5MB (5242880 bytes)
6. Allowed MIME types: `image/jpeg`, `image/png`, `image/gif`, `image/webp`
7. "Create bucket"

---

## ğŸ”’ Security Features

### 1. File Type Validation (Frontend)
```typescript
const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
```
- âœ… Nur Bild-Dateien erlaubt
- âŒ Keine .exe, .zip, .pdf, .js, etc.

### 2. File Size Validation (Frontend + Backend)
```typescript
const maxSize = 5 * 1024 * 1024; // 5MB
```
- âœ… Frontend prÃ¼ft VOR Upload
- âœ… Supabase Bucket hat auch 5MB Limit (Backup)

### 3. RLS Policies (Backend)
```sql
-- Nur authenticated users kÃ¶nnen hochladen
WITH CHECK (
  bucket_id = 'wiki-images' 
  AND auth.role() = 'authenticated'
)
```
- âœ… Anonyme User kÃ¶nnen NICHT hochladen
- âœ… Nur eingeloggte User kÃ¶nnen Bilder uploaden

### 4. Public Read Access
```sql
-- Jeder kann Bilder sehen (fÃ¼r Wiki-Artikel)
ON storage.objects FOR SELECT
USING ( bucket_id = 'wiki-images' )
```
- âœ… Wiki-Artikel sind Ã¶ffentlich â†’ Bilder auch
- âœ… Keine Authentifizierung zum Anzeigen nÃ¶tig

---

## ğŸ¦  Virenscanner: ZukÃ¼nftige Erweiterung

### User Frage: "kÃ¶nnen wir vlt n virenscanner mit einbauen?"

**Antwort:** Ja, aber spÃ¤ter! Hier der Plan:

### Phase 1: Basis Security (âœ… JETZT IMPLEMENTIERT)
- âœ… File Type Validation (nur Bilder)
- âœ… File Size Validation (max 5MB)
- âœ… RLS Policies (nur authenticated users)
- âœ… Allowed MIME types im Bucket

### Phase 2: Virus Scanning (ğŸ”® ZUKÃœNFTIG)

**Option A: ClamAV Integration** (Selbst-gehostet)
```typescript
// Edge Function: scan-uploaded-file
import { scan } from 'npm:clamav';

export default async function scanFile(filePath: string) {
  const scanResult = await scan(filePath);
  
  if (scanResult.isInfected) {
    // Datei lÃ¶schen
    await supabase.storage.from('wiki-images').remove([filePath]);
    
    // User benachrichtigen
    await createNotification({
      user_id: uploadedBy,
      type: 'security',
      title: 'Virus erkannt!',
      message: 'Deine hochgeladene Datei wurde gelÃ¶scht.'
    });
  }
}
```

**Option B: VirusTotal API** (Cloud-basiert)
```typescript
// Edge Function mit VirusTotal
const response = await fetch('https://www.virustotal.com/api/v3/files', {
  method: 'POST',
  headers: {
    'x-apikey': Deno.env.get('VIRUSTOTAL_API_KEY')
  },
  body: fileFormData
});

const scanResult = await response.json();
```

**Option C: AWS S3 + Macie** (Enterprise-Level)
- Automatische Malware-Erkennung
- Content-basierte Klassifizierung
- PII Detection

### Architektur Sketch:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User uploaded image                                         â”‚
â”‚    â†“                                                         â”‚
â”‚ Supabase Storage Trigger                                    â”‚
â”‚    â†“                                                         â”‚
â”‚ Edge Function: scan-file                                    â”‚
â”‚    â”œâ”€â†’ File Type Check âœ…                                   â”‚
â”‚    â”œâ”€â†’ File Size Check âœ…                                   â”‚
â”‚    â”œâ”€â†’ Virus Scan (ClamAV/VirusTotal)                      â”‚
â”‚    â”‚   â”œâ”€ Clean â†’ Allow âœ…                                  â”‚
â”‚    â”‚   â””â”€ Infected â†’ Delete + Notify âŒ                     â”‚
â”‚    â””â”€â†’ Optional: AI Content Moderation                     â”‚
â”‚         (NSFW, Inappropriate Content)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Kosten-Nutzen Analyse:

| Feature | Aufwand | Nutzen | Priority |
|---------|---------|--------|----------|
| **File Type Validation** | Low | High | âœ… NOW |
| **File Size Validation** | Low | High | âœ… NOW |
| **RLS Policies** | Low | High | âœ… NOW |
| **Virus Scanning** | Medium | Medium | ğŸ”® LATER |
| **Content Moderation** | High | Low | ğŸ”® OPTIONAL |

**Empfehlung:** 
- âœ… Jetzt: Basis Security (File Type + Size + RLS)
- ğŸ”® SpÃ¤ter: Virus Scanning wenn Budget vorhanden
- ğŸ”® Optional: Content Moderation fÃ¼r Ã¶ffentliche Apps

---

## âœ… Testing Guide

### Test 1: Migration ausfÃ¼hren

```bash
# In Supabase SQL Editor:
SELECT * FROM storage.buckets WHERE name = 'wiki-images';
```

**Erwartung:** Eine Zeile mit:
- id: `wiki-images`
- public: `true`
- file_size_limit: `5242880`

### Test 2: Bild hochladen

1. Wiki-Artikel erstellen/bearbeiten
2. Bild-Button klicken
3. JPG/PNG auswÃ¤hlen (< 5MB)
4. "Upload" klicken
5. **ERWARTUNG:** Bild wird hochgeladen âœ…

### Test 3: Falsche Dateitypen

1. Bild-Button klicken
2. .pdf oder .exe auswÃ¤hlen
3. **ERWARTUNG:** "Nur JPG, PNG, GIF und WebP Dateien sind erlaubt" âœ…

### Test 4: Zu groÃŸe Datei

1. Bild-Button klicken
2. Bild > 5MB auswÃ¤hlen
3. **ERWARTUNG:** "Datei ist zu groÃŸ (max. 5MB)" âœ…

### Test 5: Bucket nicht vorhanden

1. Bucket `wiki-images` lÃ¶schen (in Supabase UI)
2. Bild hochladen versuchen
3. **ERWARTUNG:** "Storage Bucket fehlt! Bitte fÃ¼hre Migration 072 aus." âœ…

---

## ğŸ“Š Code Changes Summary

| Datei | Ã„nderung | Zeilen |
|-------|----------|--------|
| `BrowoKo_RichTextEditor.tsx` | âŒ Entfernt: Auto-Create Bucket | -20 |
| `BrowoKo_RichTextEditor.tsx` | âœ… HinzugefÃ¼gt: File Validation | +15 |
| `BrowoKo_RichTextEditor.tsx` | âœ… HinzugefÃ¼gt: Better Errors | +8 |
| `072_create_wiki_images_bucket_QUICK_FIX.sql` | Migration bereit | 47 |

**Total:** ~50 Zeilen geÃ¤ndert

---

## ğŸ‰ Success Summary

### Probleme behoben:
1. âœ… RLS Policy Violation beim Bucket-Create
2. âœ… Fehlende File Validation
3. âœ… Unklare Error Messages
4. âœ… Security Gaps geschlossen

### Neue Features:
1. âœ… File Type Validation (nur Bilder)
2. âœ… File Size Validation (max 5MB)
3. âœ… User-friendly Error Messages
4. âœ… Bucket via Migration (idempotent)

### Security Improvements:
1. âœ… Frontend kann keine Buckets mehr erstellen
2. âœ… Nur authenticated users kÃ¶nnen hochladen
3. âœ… Nur erlaubte Dateitypen
4. âœ… GrÃ¶ÃŸenlimit durchgesetzt

---

## ğŸš€ Deployment Steps

### Schritt 1: Migration ausfÃ¼hren
```bash
# In Supabase SQL Editor:
# Inhalt von 072_create_wiki_images_bucket_QUICK_FIX.sql einfÃ¼gen
# Run klicken
```

### Schritt 2: Code deployen
- Code ist bereits updated in v4.12.31
- Cache leeren (Ctrl+Shift+R)

### Schritt 3: Testen
- Bild hochladen in Wiki-Artikel
- Sollte jetzt funktionieren! âœ…

---

## ğŸ“ Next Steps (Optional)

### Sofort:
- âœ… Migration 072 ausfÃ¼hren
- âœ… Bild Upload testen

### SpÃ¤ter (wenn Budget/Zeit vorhanden):
- ğŸ”® Virenscanner Integration (ClamAV oder VirusTotal)
- ğŸ”® Content Moderation (NSFW Detection)
- ğŸ”® Image Optimization (Auto-Resize, WebP Conversion)
- ğŸ”® CDN Integration (Cloudflare, CloudFront)

---

**Status:** âœ… PRODUCTION READY  
**Version:** v4.12.31  
**Security Level:** ğŸ”’ Basic (File Type + Size + RLS)  
**Next:** Run Migration 072 + Test Upload
