# v4.7.0 - SQL MIGRATIONS F√úR SUPABASE

**ANLEITUNG:**
1. √ñffne Supabase SQL Editor
2. Markiere ALLES in diesem Dokument (`Cmd+A` / `Strg+A`)
3. Kopiere (`Cmd+C` / `Strg+C`)
4. F√ºge in SQL Editor ein
5. F√ºhre aus (RUN)

---

## ‚úÖ MIGRATION 056: Extended User Fields (v4.6.0)

```sql
/**
 * Migration 056: Extended User Fields
 * Version: v4.6.0
 * 
 * F√ºgt neue Felder f√ºr Mitarbeiterdaten hinzu:
 * - birth_date (Geburtsdatum)
 * - gender (Geschlecht)
 * - country, state (Land, Bundesland)
 * - contract_status (Vertragsstatus: befristet/unbefristet)
 * - contract_end_date (Enddatum bei befristeten Vertr√§gen)
 * - re_entry_dates (Wiedereintrittsdaten - Array)
 */

-- =============================================
-- 1. ADD NEW COLUMNS TO USERS TABLE
-- =============================================

-- Gender (Geschlecht)
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS gender TEXT DEFAULT NULL;

-- Country (Land)
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS country TEXT DEFAULT NULL;

-- State/Province (Bundesland)
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS state TEXT DEFAULT NULL;

-- Contract Status (Vertragsstatus: befristet/unbefristet)
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS contract_status TEXT DEFAULT NULL;

-- Contract End Date (Enddatum bei befristeten Vertr√§gen)
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS contract_end_date DATE DEFAULT NULL;

-- Re-entry Dates (Wiedereintrittsdaten - Array)
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS re_entry_dates TEXT[] DEFAULT NULL;

-- =============================================
-- 2. ADD CONSTRAINTS
-- =============================================

-- Gender constraint (male, female, diverse)
ALTER TABLE users
DROP CONSTRAINT IF EXISTS users_gender_check;

ALTER TABLE users
ADD CONSTRAINT users_gender_check 
CHECK (gender IN ('male', 'female', 'diverse') OR gender IS NULL);

-- Contract Status constraint (unlimited, fixed_term)
ALTER TABLE users
DROP CONSTRAINT IF EXISTS users_contract_status_check;

ALTER TABLE users
ADD CONSTRAINT users_contract_status_check 
CHECK (contract_status IN ('unlimited', 'fixed_term') OR contract_status IS NULL);

-- =============================================
-- 3. ADD INDEXES FOR PERFORMANCE
-- =============================================

CREATE INDEX IF NOT EXISTS idx_users_birth_date 
ON users(birth_date) 
WHERE birth_date IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_users_gender 
ON users(gender) 
WHERE gender IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_users_country 
ON users(country) 
WHERE country IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_users_contract_status 
ON users(contract_status) 
WHERE contract_status IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_users_contract_end_date 
ON users(contract_end_date) 
WHERE contract_end_date IS NOT NULL;

-- =============================================
-- 4. CREATE AGE CALCULATION FUNCTION
-- =============================================

CREATE OR REPLACE FUNCTION calculate_age(birth_date DATE)
RETURNS INTEGER
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
  -- If no birth date provided, return NULL
  IF birth_date IS NULL THEN
    RETURN NULL;
  END IF;

  -- Calculate age in years
  RETURN EXTRACT(YEAR FROM age(CURRENT_DATE, birth_date));
END;
$$;

-- =============================================
-- 5. ADD COMMENTS FOR DOCUMENTATION
-- =============================================

COMMENT ON COLUMN users.gender IS 
'Gender of the user (male, female, diverse).';

COMMENT ON COLUMN users.country IS 
'Country of residence (e.g., Deutschland, √ñsterreich, Schweiz).';

COMMENT ON COLUMN users.state IS 
'State/Province (e.g., Bayern, Berlin, Nordrhein-Westfalen).';

COMMENT ON COLUMN users.contract_status IS 
'Employment contract status: unlimited (unbefristet) or fixed_term (befristet).';

COMMENT ON COLUMN users.contract_end_date IS 
'End date for fixed-term contracts. Only applicable when contract_status = fixed_term.';

COMMENT ON COLUMN users.re_entry_dates IS 
'Array of re-entry dates for employees who left and returned to the company.';

COMMENT ON FUNCTION calculate_age IS 
'Calculates the age in years based on birth_date.';

-- =============================================
-- 6. VALIDATION: Check if migration was successful
-- =============================================

DO $$
BEGIN
  -- Check if all columns exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'users' 
    AND column_name IN ('gender', 'country', 'state', 'contract_status', 'contract_end_date', 're_entry_dates')
    HAVING COUNT(*) = 6
  ) THEN
    RAISE EXCEPTION '‚ùå Migration 056 failed: Not all columns were created';
  END IF;

  RAISE NOTICE '‚úÖ Migration 056 completed successfully!';
  RAISE NOTICE '   - Added gender';
  RAISE NOTICE '   - Added country';
  RAISE NOTICE '   - Added state';
  RAISE NOTICE '   - Added contract_status';
  RAISE NOTICE '   - Added contract_end_date';
  RAISE NOTICE '   - Added re_entry_dates';
  RAISE NOTICE '   - Created calculate_age() function';
END $$;
```

---

## ‚úÖ MIGRATION 057: Additional User Fields (v4.7.0)

```sql
/**
 * Migration 057: Additional User Fields
 * Version: v4.7.0
 * 
 * NEW FIELDS:
 * - Probation Period & Calculation
 * - Work Phone
 * - Emergency Contacts (Array)
 * - Language Skills (Array)
 */

-- =============================================
-- 1. ADD NEW COLUMNS TO USERS TABLE
-- =============================================

-- Probation Period (in months)
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS probation_period_months INTEGER DEFAULT NULL;

-- Work Phone
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS work_phone TEXT DEFAULT NULL;

-- Emergency Contacts (JSONB Array)
-- Structure: [{first_name, last_name, phone, email}, ...]
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS emergency_contacts JSONB DEFAULT '[]'::jsonb;

-- Language Skills (JSONB Array)
-- Structure: [{language, level}, ...]
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS language_skills JSONB DEFAULT '[]'::jsonb;

-- =============================================
-- 2. ADD INDEXES FOR PERFORMANCE
-- =============================================

CREATE INDEX IF NOT EXISTS idx_users_probation_period 
ON users(probation_period_months) 
WHERE probation_period_months IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_users_work_phone 
ON users(work_phone) 
WHERE work_phone IS NOT NULL;

-- GIN indexes for JSONB array searches
CREATE INDEX IF NOT EXISTS idx_users_emergency_contacts 
ON users USING GIN (emergency_contacts);

CREATE INDEX IF NOT EXISTS idx_users_language_skills 
ON users USING GIN (language_skills);

-- =============================================
-- 3. CREATE PROBATION END DATE CALCULATION FUNCTION
-- =============================================

CREATE OR REPLACE FUNCTION calculate_probation_end_date(
  p_start_date DATE,
  p_probation_months INTEGER
)
RETURNS DATE
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
  -- If no start date or probation period, return NULL
  IF p_start_date IS NULL OR p_probation_months IS NULL THEN
    RETURN NULL;
  END IF;

  -- Calculate end date: start_date + probation_months
  RETURN p_start_date + (p_probation_months || ' months')::INTERVAL;
END;
$$;

-- =============================================
-- 4. CREATE CONTRACT DAYS REMAINING FUNCTION
-- =============================================

CREATE OR REPLACE FUNCTION calculate_contract_days_remaining(
  p_contract_end_date DATE
)
RETURNS INTEGER
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
  -- If no end date, return NULL
  IF p_contract_end_date IS NULL THEN
    RETURN NULL;
  END IF;

  -- Calculate days remaining from today
  RETURN EXTRACT(DAY FROM (p_contract_end_date - CURRENT_DATE));
END;
$$;

-- =============================================
-- 5. ADD COMMENTS FOR DOCUMENTATION
-- =============================================

COMMENT ON COLUMN users.probation_period_months IS 
'Probation period duration in months. Used with start_date to calculate probation end date.';

COMMENT ON COLUMN users.work_phone IS 
'Company/work phone number (separate from private phone).';

COMMENT ON COLUMN users.emergency_contacts IS 
'Array of emergency contacts. Each contact has: first_name, last_name, phone, email.';

COMMENT ON COLUMN users.language_skills IS 
'Array of language skills. Each skill has: language (string), level (A1, A2, B1, B2, C1, C2, native).';

COMMENT ON FUNCTION calculate_probation_end_date IS 
'Calculates probation end date by adding probation_period_months to start_date.';

COMMENT ON FUNCTION calculate_contract_days_remaining IS 
'Calculates number of days remaining until contract end date.';

-- =============================================
-- 6. VALIDATION: Check if migration was successful
-- =============================================

DO $$
BEGIN
  -- Check if all columns exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'users' 
    AND column_name IN ('probation_period_months', 'work_phone', 'emergency_contacts', 'language_skills')
    HAVING COUNT(*) = 4
  ) THEN
    RAISE EXCEPTION '‚ùå Migration 057 failed: Not all columns were created';
  END IF;

  RAISE NOTICE '‚úÖ Migration 057 completed successfully!';
  RAISE NOTICE '   - Added probation_period_months';
  RAISE NOTICE '   - Added work_phone';
  RAISE NOTICE '   - Added emergency_contacts (JSONB)';
  RAISE NOTICE '   - Added language_skills (JSONB)';
  RAISE NOTICE '   - Created calculate_probation_end_date() function';
  RAISE NOTICE '   - Created calculate_contract_days_remaining() function';
END $$;
```

---

## ‚úÖ FERTIG!

Nach dem Ausf√ºhren solltest du sehen:
- ‚úÖ Migration 056 completed successfully!
- ‚úÖ Migration 057 completed successfully!

**N√ÑCHSTER SCHRITT:** Deploy Frontend mit `npm run build` oder warte auf Auto-Deploy! üöÄ
