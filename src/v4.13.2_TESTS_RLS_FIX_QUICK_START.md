# v4.13.2 - TESTS RLS FIX üîí

**Problem:** Test kann nicht erstellt werden  
**Error:** `new row violates row-level security policy for table "tests"`  
**Ursache:** RLS Policy fehlt `WITH CHECK` Klausel f√ºr INSERT

---

## üöÄ QUICK FIX (30 Sekunden)

### **SCHRITT 1: Supabase SQL Editor √∂ffnen**
```
https://supabase.com/dashboard/project/YOUR_PROJECT/sql
```

### **SCHRITT 2: Dieses SQL ausf√ºhren**

```sql
-- Fix RLS Policy f√ºr Tests
DROP POLICY IF EXISTS "Admins can manage tests" ON tests;
DROP POLICY IF EXISTS "Admins can view tests" ON tests;
DROP POLICY IF EXISTS "Admins can create tests" ON tests;
DROP POLICY IF EXISTS "Admins can update tests" ON tests;
DROP POLICY IF EXISTS "Admins can delete tests" ON tests;

-- View Policy
CREATE POLICY "Admins can view tests"
  ON tests FOR SELECT
  USING (
    organization_id IN (
      SELECT organization_id FROM users 
      WHERE id = auth.uid() 
      AND role IN ('ADMIN', 'SUPERADMIN', 'HR')
    )
  );

-- Insert Policy (‚úÖ DAS IST DER FIX!)
CREATE POLICY "Admins can create tests"
  ON tests FOR INSERT
  WITH CHECK (
    organization_id IN (
      SELECT organization_id FROM users 
      WHERE id = auth.uid() 
      AND role IN ('ADMIN', 'SUPERADMIN', 'HR')
    )
  );

-- Update Policy
CREATE POLICY "Admins can update tests"
  ON tests FOR UPDATE
  USING (
    organization_id IN (
      SELECT organization_id FROM users 
      WHERE id = auth.uid() 
      AND role IN ('ADMIN', 'SUPERADMIN', 'HR')
    )
  );

-- Delete Policy
CREATE POLICY "Admins can delete tests"
  ON tests FOR DELETE
  USING (
    organization_id IN (
      SELECT organization_id FROM users 
      WHERE id = auth.uid() 
      AND role IN ('ADMIN', 'SUPERADMIN', 'HR')
    )
  );
```

### **SCHRITT 3: Testen**
1. **App neu laden** (Strg+Shift+R)
2. **Admin ‚Üí Lernen ‚Üí Tests**
3. **"Test erstellen" klicken**
4. **Metadaten eingeben**
5. **"Test erstellen" klicken**
6. **‚Üí Sollte jetzt zum Test Builder navigieren!** ‚úÖ

---

## üîç WAS WAR DAS PROBLEM?

### **Alte Policy (BROKEN):**
```sql
CREATE POLICY "Admins can manage tests"
  ON tests FOR ALL
  USING (
    organization_id IN (...)
  );
  -- ‚ùå FEHLT: WITH CHECK Klausel f√ºr INSERT!
```

### **Neue Policy (FIXED):**
```sql
CREATE POLICY "Admins can create tests"
  ON tests FOR INSERT
  WITH CHECK (
    organization_id IN (...)
  );
  -- ‚úÖ WITH CHECK pr√ºft beim INSERT!
```

---

## üìö HINTERGRUND: RLS USING vs WITH CHECK

| Klausel | Verwendet f√ºr | Beschreibung |
|---------|--------------|--------------|
| **USING** | SELECT, UPDATE, DELETE | Filtert bestehende Zeilen |
| **WITH CHECK** | INSERT, UPDATE | Pr√ºft neue/ge√§nderte Zeilen |

**Bei INSERT:**
- `USING` wird NICHT gepr√ºft
- Nur `WITH CHECK` wird gepr√ºft
- **Ohne `WITH CHECK` ‚Üí INSERT schl√§gt fehl!**

---

## ‚úÖ VERIFICATION

Nach dem Fix sollten diese Policies existieren:

```sql
SELECT policyname, cmd 
FROM pg_policies 
WHERE tablename = 'tests';
```

**Erwartete Ausgabe:**
```
policyname                    | cmd
------------------------------|--------
Admins can view tests        | SELECT
Admins can create tests      | INSERT  ‚úÖ
Admins can update tests      | UPDATE
Admins can delete tests      | DELETE
Users can view tests...      | SELECT
```

---

## üéØ NEXT STEPS

Nach dem Fix sollte der Workflow funktionieren:

1. **"Test erstellen"** ‚Üí Dialog √∂ffnet sich ‚úÖ
2. **Metadaten eingeben** ‚úÖ
3. **"Test erstellen" klicken** ‚úÖ
4. **‚Üí Navigiert zu `/admin/lernen/test-builder/:testId`** ‚úÖ
5. **Test Builder mit Toolbox & 10 Block-Typen** ‚úÖ

---

## üö® WICHTIG

**F√ºhre das SQL in Supabase aus, NICHT in Figma Make!**

Danach sollte Test-Erstellung sofort funktionieren! üéâ
